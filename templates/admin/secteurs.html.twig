{# Template pour le chargement AJAX - pas d'extension de base #}
<style>
    .secteur-controls {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .secteurs-table {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .secteur-checkbox {
        width: 18px;
        height: 18px;
        margin-right: 10px;
    }
    
    .secteur-color-indicator {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: inline-block;
        border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    
    #secteurs-map {
        height: 400px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .map-controls {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .btn-map-control {
        margin-right: 10px;
        margin-bottom: 5px;
    }
    
    .secteur-stats {
        background: linear-gradient(135deg, #4CAF50, #45a049);
        color: white;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
    }
</style>

<div class="admin-section">
    <div class="secteur-controls">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h3 class="section-title mb-0">
                    <i class="fas fa-map-marked-alt me-3"></i>
                    Gestion des Secteurs Commerciaux
                </h3>
                <p class="mb-0 mt-2 opacity-75">Administration et visualisation des territoires commerciaux</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-light btn-lg" onclick="nouveauSecteurModal()">
                    <i class="fas fa-plus me-2"></i>Nouveau Secteur
                </button>
            </div>
        </div>
    </div>

    <!-- Contr√¥les de carte -->
    <div class="map-controls">
        <h6 class="mb-3"><i class="fas fa-sliders-h me-2"></i>Contr√¥les de la carte</h6>
        <div class="d-flex flex-wrap">
            <button class="btn btn-outline-success btn-sm btn-map-control" onclick="afficherTousLesSecteurs()">
                <i class="fas fa-eye me-1"></i>Tout afficher
            </button>
            <button class="btn btn-outline-danger btn-sm btn-map-control" onclick="masquerTousLesSecteurs()">
                <i class="fas fa-eye-slash me-1"></i>Tout masquer
            </button>
            <button class="btn btn-outline-info btn-sm btn-map-control" onclick="centrerSurTousLesSecteurs()">
                <i class="fas fa-search-location me-1"></i>Tout voir
            </button>
        </div>
    </div>

    <div class="row">
        <!-- Colonne gauche - Liste des secteurs -->
        <div class="col-md-6">

            <!-- Statistiques -->
            <div class="secteur-stats mb-3">
                <div class="row text-center">
                    <div class="col-4">
                        <h4 id="stats-total">{{ secteurs|length }}</h4>
                        <small>Secteurs</small>
                    </div>
                    <div class="col-4">
                        <h4 id="stats-visibles">0</h4>
                        <small>Visibles</small>
                    </div>
                    <div class="col-4">
                        <h4 id="stats-actifs">{{ secteurs|filter(s => s.isActive)|length }}</h4>
                        <small>Actifs</small>
                    </div>
                </div>
            </div>

    <div class="secteurs-table">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th width="50px">
                            <input type="checkbox" class="secteur-checkbox" id="selectAll" 
                                   onchange="toggleAllSecteurs(this.checked)">
                        </th>
                        <th style="cursor: pointer;" onclick="trierSecteurs('nom')">
                            Secteur
                            <i id="tri-nom-icon" class="fas fa-sort ms-1"></i>
                        </th>
                        <th style="cursor: pointer;" onclick="trierSecteurs('commercial')">
                            Commercial
                            <i id="tri-commercial-icon" class="fas fa-sort ms-1"></i>
                        </th>
                        <th>Clients</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for secteur in secteurs %}
                    <tr id="secteur-row-{{ secteur.id }}" 
                        class="{{ not secteur.isActive ? 'table-warning' : '' }}"
                        data-nom="{{ secteur.nomSecteur|lower }}"
                        data-commercial="{{ secteur.commercial ? secteur.commercial.nom|lower : 'zzz' }}">
                        <td>
                            <input type="checkbox" 
                                   class="secteur-checkbox secteur-toggle" 
                                   id="secteur-{{ secteur.id }}"
                                   data-secteur-id="{{ secteur.id }}"
                                   onchange="toggleSecteurVisibility({{ secteur.id }}, this.checked)"
                                   {% if secteur.isActive %}checked{% endif %}>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="secteur-color-indicator me-3" 
                                      style="background-color: {{ secteur.couleurHex ?: '#3498db' }}"></span>
                                <div>
                                    <strong>{{ secteur.nomSecteur }}</strong>
                                    {% if not secteur.isActive %}
                                        <br><small class="text-warning">
                                            <i class="fas fa-pause me-1"></i>Inactif
                                        </small>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if secteur.commercial %}
                                <div>
                                    <strong>{{ secteur.commercial.nom }}</strong>
                                    <br><small class="text-muted">{{ secteur.commercial.email }}</small>
                                </div>
                            {% else %}
                                <span class="text-muted">
                                    <i class="fas fa-user-slash me-1"></i>Non assign√©
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-success">
                                <i class="fas fa-users me-1"></i>
                                {{ secteur.clients|length }}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" 
                                        onclick="voirSecteurModal({{ secteur.id }})" 
                                        title="Voir">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-primary" 
                                        onclick="modifierSecteurModal({{ secteur.id }})" 
                                        title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-success" 
                                        onclick="centrerSurSecteur({{ secteur.id }})" title="Centrer">
                                    <i class="fas fa-crosshairs"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center py-4">
                            <i class="fas fa-map-marked-alt fa-3x text-muted mb-3"></i>
                            <br>Aucun secteur configur√©
                            <br><a href="{{ path('app_secteur_new') }}" class="btn btn-primary mt-2">
                                Cr√©er le premier secteur
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
        </div>

        <!-- Colonne droite - Carte -->
        <div class="col-md-6">
            <div id="secteurs-map"></div>
            
        </div>
    </div>
</div>

<!-- Scripts Google Maps -->
<script>
    let map;
    let secteursData = {};
    let secteurPolygons = {};
    let secteurMarkers = {};

    // Variable globale pour la cl√© API - inject√©e par l'admin controller
    window.googleMapsApiKey = '{{ google_maps_api_key }}';

    function initSecteursMap() {
        console.log('üó∫Ô∏è Initialisation de la carte g√©n√©rale des secteurs');
        
        // V√©rifier que l'√©l√©ment de carte existe
        const mapElement = document.getElementById("secteurs-map");
        if (!mapElement) {
            console.error('‚ùå √âl√©ment secteurs-map non trouv√©');
            return;
        }
        
        try {
            // Carte centr√©e sur l'Occitanie avec mapId pour les marqueurs avanc√©s
            map = new google.maps.Map(mapElement, {
                center: { lat: 43.6047, lng: 1.4442 }, // Toulouse
                zoom: 8,
                mapTypeId: 'roadmap',
                mapTypeControl: true,
                streetViewControl: false,
                fullscreenControl: true,
                zoomControl: true,
                mapId: 'secteurs-map-technoprod' // Requis pour AdvancedMarkerElement
            });

            console.log('‚úÖ Carte initialis√©e avec mapId:', map.getMapId() || 'non d√©fini');
            
            // Attendre que la carte soit enti√®rement charg√©e
            google.maps.event.addListenerOnce(map, 'idle', () => {
                console.log('‚úÖ Carte pr√™te, chargement des secteurs...');
                chargerTousLesSecteurs();
            });
            
        } catch (error) {
            console.error('‚ùå Erreur initialisation carte:', error);
            mapElement.innerHTML = '<div class="alert alert-danger">Erreur d\'initialisation de la carte</div>';
        }
    }

    function chargerTousLesSecteurs() {
        console.log('üîç DEBUG: Appel API /admin/secteurs/all-geo-data');
        fetch('/admin/secteurs/all-geo-data')
            .then(response => response.json())
            .then(data => {
                console.log('üîç DEBUG: Donn√©es de tous les secteurs re√ßues:', data);
                if (data.success) {
                    secteursData = {};
                    data.secteurs.forEach(secteur => {
                        secteursData[secteur.id] = secteur;
                        // Afficher le secteur si la checkbox est coch√©e
                        if (document.getElementById(`secteur-${secteur.id}`)?.checked) {
                            afficherSecteurSurCarte(secteur);
                        }
                    });
                    mettreAJourStatistiques();
                }
            })
            .catch(error => {
                console.error('‚ùå Erreur chargement secteurs:', error);
            });
    }

    function afficherSecteurSurCarte(secteur) {
        console.log('üîç DEBUG: Affichage secteur', secteur.nom, 'hasCoordinates:', secteur.hasCoordinates);
        if (!secteur.hasCoordinates) return;

        console.log('üîç DEBUG: Secteur', secteur.nom, 'a', secteur.attributions.length, 'attributions');
        secteur.attributions.forEach((attribution, index) => {
            console.log('üîç DEBUG: Attribution', index, ':', attribution);
            // Pour les EPCI avec communes r√©elles, pas besoin de coordinates
            if ((attribution.coordinates && attribution.coordinates.length > 0) || 
                (attribution.type === 'epci' && attribution.communes && attribution.communes.length > 0)) {
                
                if (attribution.type === 'epci') {
                    if (attribution.boundary_type === 'real' || attribution.boundary_type === 'communes_reelles') {
                        afficherEpciAvecVraiesFrontieres(attribution, secteur);
                    } else {
                        afficherEpciSurCarte(attribution, secteur);
                    }
                } else {
                    afficherAttributionStandard(attribution, secteur);
                }
            }
        });

        // Cr√©er un marqueur central pour le secteur
        if (secteur.center) {
            createSecteurMarker(secteur);
        }
    }

    function createSecteurMarker(secteur) {
        try {
            // Tentative d'utilisation de l'API moderne AdvancedMarkerElement
            if (google.maps.marker && google.maps.marker.AdvancedMarkerElement && map.getMapId()) {
                console.log(`üìç Utilisation AdvancedMarkerElement pour ${secteur.nom}`);
                
                // Cr√©er un √©l√©ment DOM personnalis√© pour le marqueur
                const markerDiv = document.createElement('div');
                markerDiv.innerHTML = `
                    <div style="background: ${secteur.couleur}; border: 2px solid white; border-radius: 50%; 
                               width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
                               box-shadow: 0 2px 6px rgba(0,0,0,0.3); font-weight: bold; color: white; font-size: 10px;
                               cursor: pointer;">
                        ${secteur.nom.substring(0, 2)}
                    </div>
                `;

                const marker = new google.maps.marker.AdvancedMarkerElement({
                    map: map,
                    position: new google.maps.LatLng(secteur.center.lat, secteur.center.lng),
                    content: markerDiv,
                    title: secteur.nom
                });

                if (!secteurMarkers[secteur.id]) secteurMarkers[secteur.id] = [];
                secteurMarkers[secteur.id].push(marker);

                // InfoWindow pour les marqueurs avanc√©s
                const infoContent = `
                    <div style="max-width: 300px;">
                        <h6 style="color: ${secteur.couleur}; margin-bottom: 10px;">
                            <i class="fas fa-map-marked-alt"></i> ${secteur.nom}
                        </h6>
                        ${secteur.commercial ? `<p><strong>Commercial:</strong> ${secteur.commercial}</p>` : ''}
                        <p><strong>Attributions:</strong> ${secteur.attributions.length}</p>
                        <small class="text-info">‚ú® Marqueur moderne</small>
                        <div class="mt-2">
                            <button onclick="voirSecteurModal(${secteur.id})" class="btn btn-sm btn-primary">Voir d√©tails</button>
                        </div>
                    </div>
                `;

                const infoWindow = new google.maps.InfoWindow({ content: infoContent });
                marker.addListener('click', () => {
                    infoWindow.open({
                        anchor: marker,
                        map: map
                    });
                });
                
            } else {
                // Fallback sur l'ancienne API Marker (avec avertissement de d√©pr√©ciation)
                console.log(`üìç Utilisation Marker classique (d√©pr√©ci√©e) pour ${secteur.nom}`);
                
                const marker = new google.maps.Marker({
                    position: new google.maps.LatLng(secteur.center.lat, secteur.center.lng),
                    map: map,
                    title: secteur.nom,
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" fill="${secteur.couleur}" stroke="white" stroke-width="2"/>
                                <text x="12" y="16" text-anchor="middle" fill="white" font-size="10" font-weight="bold">${secteur.nom.substring(0, 2)}</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(24, 24),
                        anchor: new google.maps.Point(12, 12)
                    }
                });

                if (!secteurMarkers[secteur.id]) secteurMarkers[secteur.id] = [];
                secteurMarkers[secteur.id].push(marker);

                const infoContent = `
                    <div style="max-width: 300px;">
                        <h6 style="color: ${secteur.couleur}; margin-bottom: 10px;">
                            <i class="fas fa-map-marked-alt"></i> ${secteur.nom}
                        </h6>
                        ${secteur.commercial ? `<p><strong>Commercial:</strong> ${secteur.commercial}</p>` : ''}
                        <p><strong>Attributions:</strong> ${secteur.attributions.length}</p>
                        <small class="text-warning">‚ö†Ô∏è Marqueur classique</small>
                        <div class="mt-2">
                            <button onclick="voirSecteurModal(${secteur.id})" class="btn btn-sm btn-primary">Voir d√©tails</button>
                        </div>
                    </div>
                `;

                const infoWindow = new google.maps.InfoWindow({ content: infoContent });
                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });
            }
        } catch (error) {
            console.error(`‚ùå Erreur cr√©ation marqueur pour ${secteur.nom}:`, error);
        }
    }

    function afficherEpciAvecVraiesFrontieres(attribution, secteur) {
        console.log(`üó∫Ô∏è Affichage EPCI avec communes r√©elles: ${attribution.nom}`);
        
        // Utiliser les donn√©es communes directement incluses dans l'attribution
        if (attribution.communes && attribution.communes.length > 0) {
            console.log(`‚úÖ ${attribution.communes.length} communes disponibles pour EPCI ${attribution.nom}`);
            
            const polygones = [];
            const communesInfo = [];
            
            // Premi√®re passe : cr√©er tous les polygones sans contours
            attribution.communes.forEach(commune => {
                if (commune.coordinates && commune.coordinates.length >= 3) {
                    const positions = commune.coordinates.map(coord => 
                        new google.maps.LatLng(coord.lat, coord.lng)
                    );

                    // Polygone de commune SANS contour (strokeWeight: 0)
                    const polygon = new google.maps.Polygon({
                        paths: positions,
                        strokeColor: secteur.couleur,
                        strokeOpacity: 0, // Pas de contour visible
                        strokeWeight: 0,  // √âpaisseur de trait = 0
                        fillColor: secteur.couleur,
                        fillOpacity: 0.35, // Plus opaque pour compenser l'absence de contour
                        map: map
                    });

                    // Les communes forment un ensemble unifi√© sans contours internes
                    
                    // Stocker les infos de la commune pour les InfoWindows
                    communesInfo.push({
                        polygon: polygon,
                        nom: commune.nom,
                        codePostal: commune.codePostal || '',
                        pointsCount: positions.length
                    });
                    
                    polygones.push(polygon);
                    console.log(`üìç Commune ${commune.nom} ajout√©e (${positions.length} points, contour invisible)`);
                }
            });
            
            // Pas de contour ext√©rieur artificiel - seules les vraies fronti√®res des communes
            
            // Troisi√®me passe : ajouter les InfoWindows aux communes
            communesInfo.forEach(info => {
                const infoContent = `
                    <div style="max-width: 250px;">
                        <h6 style="color: ${secteur.couleur}; margin-bottom: 8px;">
                            <i class="fas fa-map-marker-alt"></i> ${info.nom}
                        </h6>
                        <small><strong>EPCI:</strong> ${attribution.nom}</small><br>
                        <small><strong>Secteur:</strong> ${secteur.nom}</small><br>
                        ${info.codePostal ? `<small><strong>Code postal:</strong> ${info.codePostal}</small><br>` : ''}
                        <small class="text-success"><strong>‚úÖ Fronti√®res r√©elles</strong></small><br>
                        <small class="text-info">Rendu unifi√© - Vraies fronti√®res uniquement</small><br>
                        <small class="text-muted">${info.pointsCount} points de fronti√®re</small>
                    </div>
                `;
                
                const infoWindow = new google.maps.InfoWindow({ content: infoContent });
                info.polygon.addListener('click', (event) => {
                    infoWindow.setPosition(event.latLng);
                    infoWindow.open(map);
                });
            });

            // Stocker tous les polygones pour la gestion de visibilit√©
            if (!secteurPolygons[secteur.id]) secteurPolygons[secteur.id] = [];
            secteurPolygons[secteur.id].push(...polygones);
            
            console.log(`üé® EPCI ${attribution.nom} affich√©: ${attribution.communes.length} communes avec rendu unifi√©, SANS contours artificiels`);
        } else {
            console.warn(`‚ö†Ô∏è Pas de communes disponibles pour EPCI ${attribution.nom}, fallback vers ancien affichage`);
            // Fallback vers l'ancien affichage
            afficherEpciSurCarte(attribution, secteur);
        }
    }

    function afficherEpciSurCarte(attribution, secteur) {
        console.log(`üî∫ Affichage EPCI avec enveloppe convexe: ${attribution.nom}`);
        
        const positions = attribution.coordinates.map(coord => 
            new google.maps.LatLng(coord.lat, coord.lng)
        );

        if (positions.length >= 3) {
            const enveloppeConvexe = calculerEnveloppeConvexe(positions);
            
            const polygon = new google.maps.Polygon({
                paths: enveloppeConvexe,
                strokeColor: secteur.couleur,
                strokeOpacity: 0.6,
                strokeWeight: 2,
                fillColor: secteur.couleur,
                fillOpacity: 0.15,
                map: map
            });

            // Ajouter une info au clic sur le polygone
            const infoContent = `
                <div style="max-width: 200px;">
                    <h6 style="color: ${secteur.couleur};">${attribution.nom}</h6>
                    <small>Secteur: ${secteur.nom}</small><br>
                    <small class="text-warning">‚ö†Ô∏è Approximation g√©om√©trique</small>
                </div>
            `;
            
            const infoWindow = new google.maps.InfoWindow({ content: infoContent });
            polygon.addListener('click', (event) => {
                infoWindow.setPosition(event.latLng);
                infoWindow.open(map);
            });

            if (!secteurPolygons[secteur.id]) secteurPolygons[secteur.id] = [];
            secteurPolygons[secteur.id].push(polygon);
        }
    }

    function afficherAttributionStandard(attribution, secteur) {
        console.log('üîç DEBUG: Attribution standard', attribution.type, attribution.nom);
        if (attribution.type === 'commune' && attribution.coordinates && attribution.coordinates.length > 0) {
            console.log('üîç DEBUG: Commune d√©tect√©e, tentative vraie forme');
            // Pour les communes, essayer d'afficher la vraie forme
            afficherCommuneAvecVraieForme(attribution, secteur);
        } else {
            console.log('üîç DEBUG: Fallback vers cercle pour', attribution.type);
            // Fallback vers les cercles pour autres types
            const coordonnee = attribution.coordinates[0];
            const position = new google.maps.LatLng(coordonnee.lat, coordonnee.lng);

            const circle = new google.maps.Circle({
                strokeColor: secteur.couleur,
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: secteur.couleur,
                fillOpacity: 0.15,
                map: map,
                center: position,
                radius: attribution.type === 'commune' ? 5000 : 
                       attribution.type === 'code_postal' ? 3000 : 
                       attribution.type === 'departement' ? 50000 : 10000
            });

            if (!secteurPolygons[secteur.id]) secteurPolygons[secteur.id] = [];
            secteurPolygons[secteur.id].push(circle);
        }
    }

    function afficherCommuneAvecVraieForme(attribution, secteur) {
        console.log('üîç DEBUG: Tentative r√©cup√©ration vraie forme pour', attribution.nom);
        // R√©cup√©rer le code INSEE de la commune depuis les donn√©es existantes
        const codeInsee = attribution.codeInsee || extractCodeInseeFromAttribution(attribution);
        
        console.log('üîç DEBUG: Code INSEE extrait:', codeInsee, 'pour', attribution.nom);
        if (!codeInsee) {
            console.warn(`‚ö†Ô∏è Code INSEE non trouv√© pour ${attribution.nom}`, attribution);
            // Fallback vers cercle
            afficherCommuneEnCercle(attribution, secteur);
            return;
        }

        console.log(`üèòÔ∏è R√©cup√©ration g√©om√©trie commune ${codeInsee} (${attribution.nom})`);

        // Appel API pour r√©cup√©rer la vraie g√©om√©trie
        fetch(`/admin/commune/${codeInsee}/geometry`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.commune.geometry && data.commune.geometry.boundaries) {
                    console.log(`‚úÖ G√©om√©trie re√ßue pour ${attribution.nom}: ${data.commune.geometry.boundaries.length} points`);
                    
                    // Afficher le polygone r√©el
                    const positions = data.commune.geometry.boundaries.map(coord => 
                        new google.maps.LatLng(coord.lat, coord.lng)
                    );

                    const polygon = new google.maps.Polygon({
                        paths: positions,
                        strokeColor: secteur.couleur,
                        strokeOpacity: 0.9,
                        strokeWeight: 2,
                        fillColor: secteur.couleur,
                        fillOpacity: 0.25,
                        map: map
                    });

                    // InfoWindow avec d√©tails
                    const infoContent = `
                        <div style="max-width: 250px;">
                            <h6 style="color: ${secteur.couleur}; margin-bottom: 8px;">
                                <i class="fas fa-map-marker-alt"></i> ${attribution.nom}
                            </h6>
                            <small><strong>Secteur:</strong> ${secteur.nom}</small><br>
                            <small class="text-success"><strong>‚úÖ Forme r√©elle</strong></small><br>
                            <small class="text-info">Source: API officielle fran√ßaise</small><br>
                            <small class="text-muted">${positions.length} points de fronti√®re</small>
                        </div>
                    `;
                    
                    const infoWindow = new google.maps.InfoWindow({ content: infoContent });
                    polygon.addListener('click', (event) => {
                        infoWindow.setPosition(event.latLng);
                        infoWindow.open(map);
                    });

                    if (!secteurPolygons[secteur.id]) secteurPolygons[secteur.id] = [];
                    secteurPolygons[secteur.id].push(polygon);

                } else {
                    console.warn(`‚ö†Ô∏è G√©om√©trie non disponible pour ${attribution.nom}, utilisation du cercle`);
                    afficherCommuneEnCercle(attribution, secteur);
                }
            })
            .catch(error => {
                console.error(`‚ùå Erreur r√©cup√©ration g√©om√©trie ${attribution.nom}:`, error);
                afficherCommuneEnCercle(attribution, secteur);
            });
    }

    function afficherCommuneEnCercle(attribution, secteur) {
        const coordonnee = attribution.coordinates[0];
        const position = new google.maps.LatLng(coordonnee.lat, coordonnee.lng);

        const circle = new google.maps.Circle({
            strokeColor: secteur.couleur,
            strokeOpacity: 0.6,
            strokeWeight: 2,
            fillColor: secteur.couleur,
            fillOpacity: 0.15,
            map: map,
            center: position,
            radius: 3000 // 3km de rayon pour les communes
        });

        if (!secteurPolygons[secteur.id]) secteurPolygons[secteur.id] = [];
        secteurPolygons[secteur.id].push(circle);
    }

    function extractCodeInseeFromAttribution(attribution) {
        // Essayer d'extraire le code INSEE depuis les donn√©es disponibles
        console.log('üîç DEBUG: Extraction code INSEE pour', attribution.nom, 'type:', attribution.type);
        
        // 1. Code INSEE directement fourni (nouveau syst√®me)
        if (attribution.codeInsee) {
            console.log('üîç DEBUG: Code INSEE trouv√© via codeInsee:', attribution.codeInsee);
            return attribution.codeInsee;
        }
        
        // 2. Pour les communes, valeur = code INSEE
        if (attribution.type === 'commune' && attribution.valeur) {
            console.log('üîç DEBUG: Code INSEE trouv√© via valeur commune:', attribution.valeur);
            return attribution.valeur;
        }
        
        // 3. Valeur = code INSEE (ancien syst√®me g√©n√©ral)
        if (attribution.valeur && attribution.valeur.length === 5) {
            console.log('üîç DEBUG: Code INSEE trouv√© via valeur g√©n√©rique:', attribution.valeur);
            return attribution.valeur;
        }
        
        // 4. Code INSEE depuis la division administrative
        if (attribution.divisionAdministrative && attribution.divisionAdministrative.codeInsee) {
            console.log('üîç DEBUG: Code INSEE trouv√© via divisionAdministrative:', attribution.divisionAdministrative.codeInsee);
            return attribution.divisionAdministrative.codeInsee;
        }
        
        console.warn('‚ö†Ô∏è Code INSEE non trouv√© dans attribution:', attribution);
        return null;
    }

    // R√©utiliser la fonction d'enveloppe convexe
    function calculerEnveloppeConvexe(points) {
        if (points.length < 3) return points;
        
        const coords = points.map(p => ({
            x: p.lng(),
            y: p.lat(),
            original: p
        }));
        
        let bottom = coords[0];
        for (let i = 1; i < coords.length; i++) {
            if (coords[i].y < bottom.y || (coords[i].y === bottom.y && coords[i].x < bottom.x)) {
                bottom = coords[i];
            }
        }
        
        const sortedCoords = coords.filter(p => p !== bottom).sort((a, b) => {
            const angleA = Math.atan2(a.y - bottom.y, a.x - bottom.x);
            const angleB = Math.atan2(b.y - bottom.y, b.x - bottom.x);
            return angleA - angleB;
        });
        
        const hull = [bottom];
        
        for (let coord of sortedCoords) {
            while (hull.length > 1) {
                const p1 = hull[hull.length - 2];
                const p2 = hull[hull.length - 1];
                const cross = (p2.x - p1.x) * (coord.y - p1.y) - (p2.y - p1.y) * (coord.x - p1.x);
                if (cross <= 0) {
                    hull.pop();
                } else {
                    break;
                }
            }
            hull.push(coord);
        }
        
        return hull.map(h => h.original);
    }

    function toggleSecteurVisibility(secteurId, visible) {
        if (visible) {
            const secteur = secteursData[secteurId];
            if (secteur) {
                afficherSecteurSurCarte(secteur);
            }
        } else {
            masquerSecteur(secteurId);
        }
        mettreAJourStatistiques();
    }

    function masquerSecteur(secteurId) {
        // Supprimer les polygones
        if (secteurPolygons[secteurId]) {
            secteurPolygons[secteurId].forEach(polygon => polygon.setMap(null));
            delete secteurPolygons[secteurId];
        }
        
        // Supprimer les marqueurs (AdvancedMarkerElement et Marker classique)
        if (secteurMarkers[secteurId]) {
            secteurMarkers[secteurId].forEach(marker => {
                try {
                    if (marker.setMap) {
                        marker.setMap(null); // Pour les marqueurs classiques
                    } else if (marker.map) {
                        marker.map = null; // Pour les AdvancedMarkerElement
                    }
                } catch (error) {
                    console.warn('Erreur suppression marqueur:', error);
                }
            });
            delete secteurMarkers[secteurId];
        }
    }

    function afficherTousLesSecteurs() {
        // V√©rifier si tous les secteurs sont d√©j√† affich√©s
        const secteurCheckboxes = document.querySelectorAll('.secteur-toggle');
        const allChecked = Array.from(secteurCheckboxes).every(checkbox => checkbox.checked);
        
        if (allChecked) {
            console.log('‚ÑπÔ∏è Tous les secteurs sont d√©j√† affich√©s');
            return; // Ne rien faire si tout est d√©j√† affich√©
        }
        
        secteurCheckboxes.forEach(checkbox => {
            if (!checkbox.checked) {
                checkbox.checked = true;
                toggleSecteurVisibility(parseInt(checkbox.dataset.secteurId), true);
            }
        });
        document.getElementById('selectAll').checked = true;
    }

    function masquerTousLesSecteurs() {
        document.querySelectorAll('.secteur-toggle').forEach(checkbox => {
            checkbox.checked = false;
            toggleSecteurVisibility(parseInt(checkbox.dataset.secteurId), false);
        });
        document.getElementById('selectAll').checked = false;
    }

    function toggleAllSecteurs(checked) {
        if (checked) {
            afficherTousLesSecteurs();
        } else {
            masquerTousLesSecteurs();
        }
    }

    function centrerSurTousLesSecteurs() {
        const bounds = new google.maps.LatLngBounds();
        let hasCoordinates = false;

        Object.values(secteursData).forEach(secteur => {
            if (secteur.hasCoordinates) {
                bounds.extend(new google.maps.LatLng(secteur.center.lat, secteur.center.lng));
                hasCoordinates = true;
            }
        });

        if (hasCoordinates) {
            map.fitBounds(bounds);
        }
    }

    function centrerSurSecteur(secteurId) {
        const secteur = secteursData[secteurId];
        if (secteur && secteur.hasCoordinates) {
            map.setCenter(new google.maps.LatLng(secteur.center.lat, secteur.center.lng));
            map.setZoom(secteur.bounds ? 10 : 12);
            
            // Cocher la checkbox si pas d√©j√† fait
            const checkbox = document.getElementById(`secteur-${secteurId}`);
            if (!checkbox.checked) {
                checkbox.checked = true;
                toggleSecteurVisibility(secteurId, true);
            }
        }
    }


    function mettreAJourStatistiques() {
        const visibles = document.querySelectorAll('.secteur-toggle:checked').length;
        document.getElementById('stats-visibles').textContent = visibles;
    }

    // Initialiser au chargement de la page
    window.initSecteurs = function() {
        console.log('üöÄ Initialisation des secteurs admin');
        
        // Les secteurs actifs sont d√©j√† coch√©s dans le template
        mettreAJourStatistiques();
        
        // Charger Google Maps dynamiquement avec la cl√© API (m√©thode moderne)
        if (window.googleMapsApiKey && window.googleMapsApiKey !== '') {
            // Utiliser la m√©thode de chargement recommand√©e par Google
            if (!window.google || !window.google.maps) {
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${window.googleMapsApiKey}&libraries=geometry,marker&loading=async&callback=initSecteursMap`;
                script.async = true;
                script.defer = true;
                
                // Gestion d'erreur de chargement
                script.onerror = function() {
                    console.error('‚ùå Erreur de chargement de Google Maps');
                    document.getElementById('secteurs-map').innerHTML = '<div class="alert alert-danger">Erreur de chargement de Google Maps</div>';
                };
                
                document.head.appendChild(script);
            } else {
                // Google Maps d√©j√† charg√©
                initSecteursMap();
            }
        } else {
            console.warn('‚ö†Ô∏è Cl√© API Google Maps non configur√©e');
            document.getElementById('secteurs-map').innerHTML = '<div class="alert alert-warning">Cl√© API Google Maps non configur√©e</div>';
        }
    };

    // Variables globales pour la gestion des secteurs
    let secteurCourantId = null;
    let divisionSelectionneeModal = null;

    // Fonction d'initialisation des √©v√©nements de la modal d'√©dition
    function initModalSecteurEventsLocal(secteurId) {
        console.log('üöÄ Initialisation modal secteur events pour secteur:', secteurId);
        secteurCourantId = secteurId;
        
        // Charger les attributions existantes
        chargerAttributionsListeModalLocal(secteurId);
        
        // Attacher les √©v√©nements avec d√©l√©gation
        const modalElement = document.getElementById('formSecteurModal');
        if (!modalElement) {
            console.error('‚ùå Modal formSecteurModal non trouv√©e');
            return;
        }
        
        // Nettoyer les anciens event listeners pour √©viter les doublons
        modalElement.removeEventListener('click', handleModalClick);
        modalElement.removeEventListener('change', handleModalChange);
        modalElement.removeEventListener('keyup', handleModalKeyup);
        
        // Attacher les nouveaux event listeners
        modalElement.addEventListener('click', handleModalClick);
        modalElement.addEventListener('change', handleModalChange);
        modalElement.addEventListener('keyup', handleModalKeyup);
        
        console.log('‚úÖ Event listeners attach√©s avec succ√®s');
    }
    
    function handleModalClick(e) {
        if (e.target.matches('#btn-toggle-ajout') || e.target.closest('#btn-toggle-ajout')) {
            e.preventDefault();
            console.log('üîò Clic bouton toggle ajout');
            toggleAjoutAttributionLocal();
        }
        
        if (e.target.matches('#btn-annuler-ajout') || e.target.closest('#btn-annuler-ajout')) {
            e.preventDefault();
            console.log('üîò Clic bouton annuler ajout');
            toggleAjoutAttributionLocal();
        }
        
        if (e.target.matches('#btn-ajouter-attribution-modal') || e.target.closest('#btn-ajouter-attribution-modal')) {
            e.preventDefault();
            console.log('üîò Clic bouton ajouter attribution');
            ajouterAttributionModalLocal();
        }
        
        if (e.target.matches('#btn-deselectionner') || e.target.closest('#btn-deselectionner')) {
            e.preventDefault();
            console.log('üîò Clic bouton d√©selectionner');
            deselectionnerDivisionModalLocal();
        }
        
        if (e.target.matches('.btn-supprimer-attribution') || e.target.closest('.btn-supprimer-attribution')) {
            e.preventDefault();
            const btn = e.target.matches('.btn-supprimer-attribution') ? e.target : e.target.closest('.btn-supprimer-attribution');
            const attributionId = btn.getAttribute('data-attribution-id');
            console.log('üîò Clic supprimer attribution:', attributionId);
            supprimerAttributionModalLocal(attributionId);
        }
        
        if (e.target.matches('.btn-selectionner-division') || e.target.closest('.btn-selectionner-division')) {
            e.preventDefault();
            const btn = e.target.matches('.btn-selectionner-division') ? e.target : e.target.closest('.btn-selectionner-division');
            const id = btn.getAttribute('data-division-id');
            const nom = btn.getAttribute('data-division-nom');
            const valeur = btn.getAttribute('data-division-valeur');
            const type = btn.getAttribute('data-division-type');
            console.log('üîò Clic s√©lectionner division:', nom);
            selectionnerDivisionModalLocal(id, nom, valeur, type);
        }
    }
    
    function handleModalChange(e) {
        if (e.target.matches('#type-attribution-modal')) {
            console.log('üîò Changement type attribution:', e.target.value);
            changerTypeAttributionModalLocal();
        }
    }
    
    function handleModalKeyup(e) {
        if (e.target.matches('#recherche-attribution-modal')) {
            console.log('üîò Recherche division:', e.target.value);
            rechercherDivisionModalLocal();
        }
    }
    
    function chargerAttributionsListeModalLocal(secteurId) {
        console.log('üìã Chargement attributions pour secteur:', secteurId);
        
        const listeContainer = document.getElementById('attributions-liste-modal');
        if (!listeContainer) {
            console.error('‚ùå Container attributions-liste-modal non trouv√©');
            return;
        }
        
        listeContainer.innerHTML = '<div class="text-center text-muted py-2"><div class="spinner-border spinner-border-sm" role="status"></div><p class="mt-2 mb-0 small">Chargement...</p></div>';
        
        const url = `/secteur/ajax/${secteurId}/attributions`;
        console.log('üîó Appel API:', url);
        
        fetch(url)
            .then(response => {
                console.log('üì° R√©ponse API:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('üìä Donn√©es re√ßues:', data);
                if (data.success) {
                    if (data.attributions.length === 0) {
                        listeContainer.innerHTML = '<div class="alert alert-info"><small><i class="fas fa-info-circle me-1"></i>Aucune zone g√©ographique d√©finie</small></div>';
                    } else {
                        let html = '<div class="list-group list-group-flush">';
                        data.attributions.forEach(attribution => {
                            const icon = getTypeIconModalLocal(attribution.typeCritere);
                            html += `
                                <div class="list-group-item d-flex justify-content-between align-items-center p-2">
                                    <div>
                                        <small class="fw-bold">${icon} ${attribution.division.nom}</small>
                                        <br><small class="text-muted">${attribution.typeCritere} - ${attribution.valeurCritere}</small>
                                        ${attribution.notes ? '<br><small class="text-muted fst-italic">' + attribution.notes + '</small>' : ''}
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-danger btn-supprimer-attribution" 
                                            data-attribution-id="${attribution.id}"
                                            title="Supprimer cette attribution">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                        });
                        html += '</div>';
                        listeContainer.innerHTML = html;
                    }
                    
                    // Mettre √† jour le compteur de zones
                    const statsElement = document.getElementById('stats-attributions');
                    if (statsElement) {
                        statsElement.textContent = data.attributions.length;
                    }
                    
                    console.log('‚úÖ Attributions charg√©es:', data.attributions.length);
                } else {
                    listeContainer.innerHTML = '<div class="alert alert-danger small">Erreur lors du chargement</div>';
                }
            })
            .catch(error => {
                console.error('‚ùå Erreur API:', error);
                listeContainer.innerHTML = '<div class="alert alert-danger small">Erreur de communication</div>';
            });
    }
    
    function toggleAjoutAttributionLocal() {
        console.log('üîÑ Toggle ajout attribution');
        const ajoutSection = document.getElementById('ajout-attribution-modal');
        if (!ajoutSection) {
            console.error('‚ùå Section ajout-attribution-modal non trouv√©e');
            return;
        }
        
        if (ajoutSection.style.display === 'none' || ajoutSection.style.display === '') {
            console.log('üëÅÔ∏è Affichage section ajout');
            ajoutSection.style.display = 'block';
        } else {
            console.log('üîí Masquage section ajout');
            ajoutSection.style.display = 'none';
            reinitialiserFormulaireModalLocal();
        }
    }
    
    function getTypeIconModalLocal(type) {
        const icons = {
            'code_postal': 'üìÆ',
            'commune': 'üèòÔ∏è',
            'canton': 'üó∫Ô∏è',
            'epci': 'üèõÔ∏è',
            'departement': 'üèûÔ∏è',
            'region': 'üåç'
        };
        return icons[type] || 'üìç';
    }
    
    function reinitialiserFormulaireModalLocal() {
        const typeSelect = document.getElementById('type-attribution-modal');
        if (typeSelect) typeSelect.value = '';
        
        const zoneRecherche = document.getElementById('zone-recherche-modal');
        if (zoneRecherche) zoneRecherche.style.display = 'none';
        
        reinitialiserRechercheModalLocal();
    }
    
    function reinitialiserRechercheModalLocal() {
        const rechercheInput = document.getElementById('recherche-attribution-modal');
        if (rechercheInput) rechercheInput.value = '';
        
        const notesInput = document.getElementById('notes-attribution-modal');
        if (notesInput) notesInput.value = '';
        
        const resultsContainer = document.getElementById('resultats-attribution-modal');
        if (resultsContainer) resultsContainer.innerHTML = '';
        
        deselectionnerDivisionModalLocal();
    }
    
    function changerTypeAttributionModalLocal() {
        const typeSelect = document.getElementById('type-attribution-modal');
        const zoneRecherche = document.getElementById('zone-recherche-modal');
        
        if (typeSelect && typeSelect.value) {
            if (zoneRecherche) {
                zoneRecherche.style.display = 'block';
                const rechercheInput = document.getElementById('recherche-attribution-modal');
                if (rechercheInput) rechercheInput.focus();
            }
            reinitialiserRechercheModalLocal();
        } else {
            if (zoneRecherche) zoneRecherche.style.display = 'none';
        }
    }
    
    function rechercherDivisionModalLocal() {
        const typeSelect = document.getElementById('type-attribution-modal');
        const rechercheInput = document.getElementById('recherche-attribution-modal');
        const resultsContainer = document.getElementById('resultats-attribution-modal');
        
        if (!typeSelect || !rechercheInput || !resultsContainer) return;
        
        const type = typeSelect.value;
        const terme = rechercheInput.value.trim();
        
        if (!type || terme.length < 2) {
            resultsContainer.innerHTML = '';
            return;
        }
        
        resultsContainer.innerHTML = '<div class="text-center small text-muted"><i class="fas fa-spinner fa-spin"></i> Recherche...</div>';
        
        fetch(`/admin/divisions-administratives/recherche?type=${type}&terme=${encodeURIComponent(terme)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.results.length > 0) {
                    let html = '<div class="list-group list-group-flush">';
                    data.results.forEach(result => {
                        const icon = getTypeIconModalLocal(type);
                        html += `
                            <button type="button" class="list-group-item list-group-item-action p-2 btn-selectionner-division" 
                                    data-division-id="${result.id}" data-division-nom="${result.nom}" 
                                    data-division-valeur="${result.valeur}" data-division-type="${type}">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <small class="fw-bold">${icon} ${result.nom}</small>
                                        <br><small class="text-muted">${result.details || result.valeur}</small>
                                    </div>
                                    <i class="fas fa-chevron-right small text-muted"></i>
                                </div>
                            </button>
                        `;
                    });
                    html += '</div>';
                    resultsContainer.innerHTML = html;
                } else {
                    resultsContainer.innerHTML = '<div class="text-muted text-center small">Aucun r√©sultat trouv√©</div>';
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                resultsContainer.innerHTML = '<div class="alert alert-danger small">Erreur de recherche</div>';
            });
    }
    
    function selectionnerDivisionModalLocal(id, nom, valeur, type) {
        divisionSelectionneeModal = { id, nom, valeur, type };
        
        const divisionSelectionnee = document.getElementById('division-selectionnee-modal');
        const divisionNom = document.getElementById('division-selectionnee-nom-modal');
        const btnAjouter = document.getElementById('btn-ajouter-attribution-modal');
        const resultsContainer = document.getElementById('resultats-attribution-modal');
        
        if (divisionSelectionnee) divisionSelectionnee.style.display = 'block';
        if (divisionNom) divisionNom.textContent = `${getTypeIconModalLocal(type)} ${nom}`;
        if (btnAjouter) btnAjouter.disabled = false;
        if (resultsContainer) resultsContainer.innerHTML = '';
    }
    
    function deselectionnerDivisionModalLocal() {
        divisionSelectionneeModal = null;
        
        const divisionSelectionnee = document.getElementById('division-selectionnee-modal');
        const btnAjouter = document.getElementById('btn-ajouter-attribution-modal');
        
        if (divisionSelectionnee) divisionSelectionnee.style.display = 'none';
        if (btnAjouter) btnAjouter.disabled = true;
    }
    
    function ajouterAttributionModalLocal() {
        if (!divisionSelectionneeModal || !secteurCourantId) {
            console.error('‚ùå Donn√©es manquantes pour ajouter attribution');
            return;
        }
        
        const notesInput = document.getElementById('notes-attribution-modal');
        const notes = notesInput ? notesInput.value.trim() : '';
        
        const data = {
            secteurId: secteurCourantId,
            divisionId: divisionSelectionneeModal.id,
            typeCritere: divisionSelectionneeModal.type,
            valeurCritere: divisionSelectionneeModal.valeur,
            notes: notes
        };
        
        console.log('üì§ Ajout attribution:', data);
        
        fetch('/admin/secteur/attribution/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                console.log('‚úÖ Attribution ajout√©e avec succ√®s');
                chargerAttributionsListeModalLocal(secteurCourantId);
                reinitialiserFormulaireModalLocal();
                toggleAjoutAttributionLocal();
            } else {
                alert(result.message || 'Erreur lors de l\'ajout');
            }
        })
        .catch(error => {
            console.error('‚ùå Erreur:', error);
            alert('Erreur de communication');
        });
    }
    
    function supprimerAttributionModalLocal(attributionId) {
        if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette attribution ?')) return;
        
        console.log('üóëÔ∏è Suppression attribution:', attributionId);
        
        fetch(`/admin/secteur/attribution/${attributionId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                console.log('‚úÖ Attribution supprim√©e avec succ√®s');
                chargerAttributionsListeModalLocal(secteurCourantId);
            } else {
                alert(result.message || 'Erreur lors de la suppression');
            }
        })
        .catch(error => {
            console.error('‚ùå Erreur:', error);
            alert('Erreur de communication');
        });
    }
    
    function initFormSubmissionHandler() {
        console.log('üìù Initialisation gestionnaire soumission formulaire');
        
        const form = document.getElementById('secteur-modal-form');
        if (!form) {
            console.error('‚ùå Formulaire secteur-modal-form non trouv√©');
            return;
        }
        
        // Supprimer l'ancien gestionnaire s'il existe
        form.removeEventListener('submit', handleFormSubmission);
        
        // Ajouter le nouveau gestionnaire
        form.addEventListener('submit', handleFormSubmission);
        
        console.log('‚úÖ Gestionnaire de soumission attach√©');
    }
    
    function handleFormSubmission(event) {
        event.preventDefault();
        console.log('üì§ Soumission formulaire intercept√©e');
        
        const form = event.target;
        const formData = new FormData(form);
        const submitButton = document.querySelector('button[form="secteur-modal-form"][type="submit"]');
        
        // D√©sactiver le bouton de soumission
        if (submitButton) {
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Enregistrement...';
        }
        
        // Debug: Afficher les donn√©es du formulaire
        console.log('üìã Donn√©es formulaire:');
        for (let [key, value] of formData.entries()) {
            console.log(`  ${key}: ${value}`);
        }
        
        // R√©cup√©rer l'URL d'action du formulaire
        const actionUrl = form.getAttribute('action');
        console.log('üîó URL d\'action:', actionUrl);
        
        fetch(actionUrl, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log('üì° R√©ponse serveur:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üìä Donn√©es re√ßues:', data);
            
            if (data.success) {
                console.log('‚úÖ Secteur sauvegard√© avec succ√®s');
                
                // Fermer la modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('formSecteurModal'));
                if (modal) {
                    modal.hide();
                }
                
                // Recharger la liste des secteurs
                if (typeof rechargerListeSecteurs === 'function') {
                    rechargerListeSecteurs();
                } else {
                    // Recharger la page si pas de fonction de rechargement
                    location.reload();
                }
                
            } else {
                console.error('‚ùå Erreur lors de la sauvegarde:', data.errors || data.error);
                
                if (data.errors && Array.isArray(data.errors)) {
                    alert('Erreurs de validation:\n' + data.errors.join('\n'));
                } else {
                    alert('Erreur lors de l\'enregistrement: ' + (data.error || 'Erreur inconnue'));
                }
            }
        })
        .catch(error => {
            console.error('‚ùå Erreur de communication:', error);
            alert('Erreur de communication avec le serveur');
        })
        .finally(() => {
            // R√©activer le bouton de soumission
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-save me-1"></i>Enregistrer';
            }
        });
    }

    // Fonctions pour les modales
    function voirSecteurModal(secteurId) {
        secteurCourantId = secteurId;
        fetch(`/secteur/ajax/${secteurId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const secteur = data.secteur;
                    const modalBody = document.getElementById('voirSecteurModalBody');
                    
                    modalBody.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-info-circle text-info me-2"></i>Informations g√©n√©rales</h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Nom :</strong></td>
                                        <td>${secteur.nomSecteur}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Couleur :</strong></td>
                                        <td>
                                            <span class="secteur-color-indicator me-2" style="background-color: ${secteur.couleurHex}"></span>
                                            ${secteur.couleurHex}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Statut :</strong></td>
                                        <td>
                                            <span class="badge ${secteur.isActive ? 'bg-success' : 'bg-warning'}">
                                                ${secteur.isActive ? 'Actif' : 'Inactif'}
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Cr√©√© le :</strong></td>
                                        <td>${secteur.createdAt || 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Modifi√© le :</strong></td>
                                        <td>${secteur.updatedAt || 'N/A'}</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-user text-primary me-2"></i>Commercial assign√©</h6>
                                ${secteur.commercial ? `
                                    <div class="card border-primary mb-3">
                                        <div class="card-body">
                                            <h6 class="card-title">${secteur.commercial.nom}</h6>
                                            <p class="card-text">
                                                <i class="fas fa-envelope me-1"></i>${secteur.commercial.email}
                                            </p>
                                        </div>
                                    </div>
                                ` : '<p class="text-muted">Aucun commercial assign√©</p>'}
                                
                                <h6><i class="fas fa-chart-bar text-success me-2"></i>Statistiques</h6>
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="border rounded p-2">
                                            <h5 class="text-primary">${secteur.clients_count}</h5>
                                            <small>Clients</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="border rounded p-2">
                                            <h5 class="text-info">${secteur.attributions_count}</h5>
                                            <small>Attributions</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ${secteur.description ? `
                            <div class="mt-3">
                                <h6><i class="fas fa-comment text-secondary me-2"></i>Description</h6>
                                <p class="text-muted">${secteur.description}</p>
                            </div>
                        ` : ''}
                        
                        <div class="mt-3">
                            <h6><i class="fas fa-map-marked-alt text-warning me-2"></i>Attributions g√©ographiques</h6>
                            ${secteur.attributions && secteur.attributions.length > 0 ? `
                                <div class="list-group">
                                    ${secteur.attributions.map(attr => {
                                        const typeIcons = {
                                            'code_postal': 'üìÆ',
                                            'commune': 'üèòÔ∏è',
                                            'canton': 'üó∫Ô∏è',
                                            'epci': 'üèõÔ∏è',
                                            'departement': 'üèûÔ∏è',
                                            'region': 'üåç'
                                        };
                                        const icon = typeIcons[attr.typeCritere] || 'üìç';
                                        return `
                                            <div class="list-group-item d-flex justify-content-between align-items-start">
                                                <div>
                                                    <div class="fw-bold">${icon} ${attr.division.nom}</div>
                                                    <small class="text-muted">Type: ${attr.typeCritere}</small>
                                                    ${attr.notes ? `<br><small class="text-info">${attr.notes}</small>` : ''}
                                                </div>
                                                <span class="badge bg-secondary">${attr.valeurCritere}</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : '<p class="text-muted text-center py-3">Aucune attribution g√©ographique configur√©e</p>'}
                        </div>
                    `;
                    
                    const modal = new bootstrap.Modal(document.getElementById('voirSecteurModal'));
                    modal.show();
                } else {
                    console.error('Erreur serveur:', data.error);
                    alert('Erreur: ' + (data.error || 'Erreur inconnue'));
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors du chargement des donn√©es du secteur');
            });
    }

    function modifierSecteurModal(secteurId) {
        fetch(`/secteur/ajax/${secteurId}/edit-form`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('formSecteurModalLabel').textContent = data.title;
                    document.getElementById('formSecteurModalBody').innerHTML = data.html;
                    
                    const modal = new bootstrap.Modal(document.getElementById('formSecteurModal'));
                    modal.show();
                    
                    // Apr√®s ouverture de la modal, initialiser les √©v√©nements
                    modal._element.addEventListener('shown.bs.modal', function () {
                        setTimeout(() => {
                            console.log('üîç Initialisation des √©v√©nements modal secteur pour ID:', secteurId);
                            initModalSecteurEventsLocal(secteurId);
                            initFormSubmissionHandler();
                        }, 200);
                    }, { once: true });
                } else {
                    alert('Erreur lors du chargement du formulaire');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors du chargement du formulaire');
            });
    }

    function nouveauSecteurModal() {
        fetch('/secteur/ajax/new-form')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('formSecteurModalLabel').textContent = data.title;
                    document.getElementById('formSecteurModalBody').innerHTML = data.html;
                    
                    const modal = new bootstrap.Modal(document.getElementById('formSecteurModal'));
                    
                    // Initialiser le gestionnaire de soumission pour nouveau secteur
                    modal._element.addEventListener('shown.bs.modal', function () {
                        setTimeout(() => {
                            console.log('üîç Initialisation gestionnaire pour nouveau secteur');
                            initFormSubmissionHandler();
                        }, 200);
                    }, { once: true });
                    
                    modal.show();
                } else {
                    console.error('Erreur serveur:', data.error);
                    alert('Erreur: ' + (data.error || 'Erreur inconnue'));
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors du chargement du formulaire');
            });
    }

    // Fonction supprim√©e - gestion de soumission maintenant dans handleFormSubmission

    // Variables pour le tri
    let triActuel = { colonne: null, direction: 'asc' };

    function trierSecteurs(colonne) {
        const tbody = document.querySelector('.secteurs-table tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        // D√©terminer la direction du tri
        if (triActuel.colonne === colonne) {
            triActuel.direction = triActuel.direction === 'asc' ? 'desc' : 'asc';
        } else {
            triActuel.direction = 'asc';
            triActuel.colonne = colonne;
        }
        
        // R√©initialiser toutes les ic√¥nes
        document.querySelectorAll('[id^="tri-"]').forEach(icon => {
            icon.className = 'fas fa-sort ms-1';
        });
        
        // Mettre √† jour l'ic√¥ne de la colonne tri√©e
        const icon = document.getElementById(`tri-${colonne}-icon`);
        icon.className = `fas fa-sort-${triActuel.direction === 'asc' ? 'up' : 'down'} ms-1`;
        
        // Trier les lignes
        rows.sort((a, b) => {
            let valeurA = a.dataset[colonne] || '';
            let valeurB = b.dataset[colonne] || '';
            
            // Gestion sp√©ciale pour les commerciaux non assign√©s
            if (colonne === 'commercial') {
                if (valeurA === 'zzz') valeurA = ''; // Non assign√© en dernier
                if (valeurB === 'zzz') valeurB = ''; // Non assign√© en dernier
            }
            
            const comparaison = valeurA.localeCompare(valeurB, 'fr', { 
                numeric: true, 
                sensitivity: 'base' 
            });
            
            return triActuel.direction === 'asc' ? comparaison : -comparaison;
        });
        
        // R√©ins√©rer les lignes tri√©es
        rows.forEach(row => tbody.appendChild(row));
        
        console.log(`üîÑ Tri appliqu√©: ${colonne} ${triActuel.direction}`);
    }

    // Fonctions pour les nouveaux boutons de la modal voir secteur
    function modifierSecteurDepuisVoir() {
        if (secteurCourantId) {
            // Fermer la modal voir
            const voirModal = bootstrap.Modal.getInstance(document.getElementById('voirSecteurModal'));
            voirModal.hide();
            
            // Ouvrir la modal modifier
            setTimeout(() => {
                modifierSecteurModal(secteurCourantId);
            }, 300);
        }
    }

    // Fonction pour recharger la liste des secteurs sans recharger la page
    function rechargerListeSecteurs() {
        console.log('üîÑ Rechargement de la liste des secteurs...');
        
        // Recharger le contenu du tableau
        fetch(window.location.href)
            .then(response => response.text())
            .then(html => {
                // Cr√©er un document temporaire pour parser le HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Extraire le nouveau tableau
                const nouveauTableau = doc.querySelector('.secteurs-table tbody');
                const tableauActuel = document.querySelector('.secteurs-table tbody');
                
                if (nouveauTableau && tableauActuel) {
                    // Remplacer le contenu du tableau
                    tableauActuel.innerHTML = nouveauTableau.innerHTML;
                    console.log('‚úÖ Tableau des secteurs mis √† jour');
                }
                
                // Mettre √† jour les checkboxes et la carte si n√©cessaire
                if (typeof chargerTousLesSecteurs === 'function') {
                    chargerTousLesSecteurs();
                }
            })
            .catch(error => {
                console.error('‚ùå Erreur lors du rechargement:', error);
                // En cas d'erreur, recharger la page compl√®te
                location.reload();
            });
    }

    function supprimerSecteur() {
        if (!secteurCourantId) return;
        
        if (confirm('√ätes-vous s√ªr de vouloir supprimer ce secteur ? Cette action est irr√©versible.')) {
            fetch(`/secteur/ajax/${secteurCourantId}/delete`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Fermer la modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('voirSecteurModal'));
                    modal.hide();
                    
                    // Recharger seulement la liste des secteurs
                    rechargerListeSecteurs();
                } else {
                    alert('Erreur lors de la suppression : ' + (data.error || 'Erreur inconnue'));
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors de la suppression du secteur');
            });
        }
    }
</script>

<!-- Modales -->
<!-- Modal Voir Secteur -->
<div class="modal fade" id="voirSecteurModal" tabindex="-1" aria-labelledby="voirSecteurModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="voirSecteurModalLabel">
                    <i class="fas fa-eye text-info me-2"></i>D√©tails du secteur
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="voirSecteurModalBody">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-danger" id="btn-supprimer-secteur" onclick="supprimerSecteur()">
                    <i class="fas fa-trash me-1"></i>Supprimer
                </button>
                <button type="button" class="btn btn-primary" id="btn-modifier-secteur" onclick="modifierSecteurDepuisVoir()">
                    <i class="fas fa-edit me-1"></i>Modifier
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Formulaire Secteur (Nouveau/√âdition) -->
<div class="modal fade" id="formSecteurModal" tabindex="-1" aria-labelledby="formSecteurModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" style="max-height: 90vh; margin-top: 2vh;">
        <div class="modal-content" style="height: 86vh; max-height: 86vh;">
            <div class="modal-header flex-shrink-0">
                <h5 class="modal-title" id="formSecteurModalLabel">
                    <i class="fas fa-edit text-primary me-2"></i>Secteur
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body overflow-auto flex-grow-1" id="formSecteurModalBody">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer flex-shrink-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="submit" form="secteur-modal-form" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>

{# Fin du template AJAX #}