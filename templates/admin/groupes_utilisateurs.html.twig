<div class="admin-section">
    <h3 class="section-title">
        <i class="fas fa-users me-2"></i>Gestion des Groupes Utilisateurs
    </h3>
    <p class="text-muted mb-4">Configuration des groupes et des droits d'acc√®s avec hi√©rarchie et permissions</p>

    <!-- Statistiques rapides -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-primary">{{ stats.total }}</h4>
                    <small class="text-muted">Groupes Total</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-success">{{ stats.actifs }}</h4>
                    <small class="text-muted">Actifs</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-warning">{{ stats.racines }}</h4>
                    <small class="text-muted">Groupes Racines</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-info">{{ stats.enfants }}</h4>
                    <small class="text-muted">Sous-groupes</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions rapides -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <button type="button" class="btn btn-primary" onclick="ouvrirModalGroupe()">
                <i class="fas fa-plus me-1"></i>Nouveau Groupe
            </button>
            <button type="button" class="btn btn-outline-secondary ms-2" onclick="reorganiserOrdres()">
                <i class="fas fa-sort me-1"></i>R√©organiser
            </button>
        </div>
        <div class="input-group" style="width: 300px;">
            <input type="text" class="form-control" id="searchGroupe" placeholder="Rechercher un groupe...">
            <button class="btn btn-outline-secondary" type="button">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>

    <!-- Tableau des groupes -->
    <div class="card">
        <div class="card-body p-0">
            {% if groupes|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="tableGroupes">
                        <thead>
                            <tr>
                                <th width="8%">Ordre</th>
                                <th width="20%">Nom</th>
                                <th width="25%">Description</th>
                                <th width="12%">Niveau</th>
                                <th width="10%">Permissions</th>
                                <th width="10%">Utilisateurs</th>
                                <th width="8%">Statut</th>
                                <th width="7%">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for groupe in groupes %}
                                <tr data-groupe-id="{{ groupe.id }}" 
                                    {% if not groupe.actif %}class="table-secondary"{% endif %}>
                                    <td>
                                        <span class="badge bg-secondary">{{ groupe.ordre }}</span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if groupe.couleur %}
                                                <div class="me-2" style="width: 12px; height: 12px; border-radius: 50%; background-color: {{ groupe.couleur }};"></div>
                                            {% endif %}
                                            <div>
                                                <strong>{{ groupe.nomAffiche }}</strong>
                                                {% if groupe.parent %}
                                                    <br><small class="text-muted">‚Ü≥ Enfant de {{ groupe.parent.nom }}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="text-muted">{{ groupe.description|default('Aucune description') }}</span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress me-2" style="width: 60px; height: 10px;">
                                                <div class="progress-bar" role="progressbar" 
                                                     style="width: {{ (groupe.niveau / 10) * 100 }}%" 
                                                     aria-valuenow="{{ groupe.niveau }}" 
                                                     aria-valuemin="0" aria-valuemax="10"></div>
                                            </div>
                                            <span class="badge bg-primary">{{ groupe.niveau }}/10</span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ groupe.permissions|length }}</span>
                                        {% if groupe.permissions|length > 0 %}
                                            <i class="fas fa-info-circle text-muted ms-1" 
                                               title="{{ groupe.permissions|join(', ') }}"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ groupe.nombreUtilisateurs }}</span>
                                    </td>
                                    <td>
                                        {% if groupe.actif %}
                                            <span class="badge bg-success">Actif</span>
                                        {% else %}
                                            <span class="badge bg-danger">Inactif</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" 
                                                    onclick="voirGroupe({{ groupe.id }})" 
                                                    title="Voir d√©tails">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary" 
                                                    onclick="modifierGroupe({{ groupe.id }})" 
                                                    title="Modifier">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-warning" 
                                                    onclick="toggleGroupe({{ groupe.id }})" 
                                                    title="{% if groupe.actif %}D√©sactiver{% else %}Activer{% endif %}">
                                                <i class="fas fa-{% if groupe.actif %}pause{% else %}play{% endif %}"></i>
                                            </button>
                                            {% if groupe.nombreUtilisateurs == 0 and groupe.enfants|length == 0 %}
                                                <button class="btn btn-outline-danger" 
                                                        onclick="supprimerGroupe({{ groupe.id }})" 
                                                        title="Supprimer">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h5>Aucun groupe configur√©</h5>
                    <p class="text-muted mb-3">Commencez par cr√©er votre premier groupe d'utilisateurs</p>
                    <button type="button" class="btn btn-primary" onclick="ouvrirModalGroupe()">
                        <i class="fas fa-plus me-1"></i>Cr√©er un groupe
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Groupe -->
<div class="modal fade" id="modalGroupe" tabindex="-1" aria-labelledby="modalGroupeLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalGroupeLabel">
                    <span id="modalGroupeTitle">Nouveau Groupe</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formGroupe">
                    <div class="row">
                        <!-- Informations g√©n√©rales -->
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-1"></i>Informations G√©n√©rales</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="groupeNom" class="form-label">Nom du groupe *</label>
                                        <input type="text" class="form-control" id="groupeNom" name="nom" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="groupeDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="groupeDescription" name="description" rows="3"></textarea>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="groupeNiveau" class="form-label">Niveau (1-10)</label>
                                            <input type="number" class="form-control" id="groupeNiveau" name="niveau" min="1" max="10" value="5">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="groupeCouleur" class="form-label">Couleur</label>
                                            <input type="color" class="form-control form-control-color" id="groupeCouleur" name="couleur" value="#6c757d">
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="groupeParent" class="form-label">Groupe parent (optionnel)</label>
                                        <select class="form-select" id="groupeParent" name="parent_id">
                                            <option value="">Aucun parent (groupe racine)</option>
                                            {% for g in groupes %}
                                                {% if g.actif %}
                                                    <option value="{{ g.id }}">{{ g.nomAffiche }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="groupeActif" name="actif" checked>
                                        <label class="form-check-label" for="groupeActif">
                                            Groupe actif
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Permissions -->
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="fas fa-key me-1"></i>Permissions</h6>
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    {% for category, perms in available_permissions %}
                                        <h6 class="text-uppercase fw-bold mt-3 mb-2 text-primary">{{ category|title }}</h6>
                                        <div class="row">
                                            {% for perm, label in perms %}
                                                <div class="col-12 mb-1">
                                                    <div class="form-check form-check-sm">
                                                        <input class="form-check-input permission-checkbox" 
                                                               type="checkbox" 
                                                               id="perm_{{ perm|replace({'.': '_'}) }}" 
                                                               value="{{ perm }}">
                                                        <label class="form-check-label small" for="perm_{{ perm|replace({'.': '_'}) }}">
                                                            {{ label }}
                                                        </label>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Soci√©t√©s -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-building me-1"></i>Acc√®s aux Soci√©t√©s</h6>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-2">S√©lectionnez les soci√©t√©s auxquelles ce groupe donne acc√®s (laissez vide pour acc√®s global)</p>
                            <div id="societesList">
                                <!-- Les soci√©t√©s seront charg√©es via AJAX -->
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="sauvegarderGroupe()">
                    <i class="fas fa-save me-1"></i>Sauvegarder
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation -->
<div class="modal fade" id="modalConfirmation" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="messageConfirmation"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="btnConfirmer">Confirmer</button>
            </div>
        </div>
    </div>
</div>

<script>
let groupeEnCours = null;

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    // Recherche en temps r√©el
    document.getElementById('searchGroupe').addEventListener('input', function() {
        filtrerGroupes(this.value);
    });
    
    // Activer les tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

function ouvrirModalGroupe(groupeId = null) {
    const modal = new bootstrap.Modal(document.getElementById('modalGroupe'));
    
    if (groupeId) {
        // Mode √©dition
        document.getElementById('modalGroupeTitle').textContent = 'Modifier le Groupe';
        chargerGroupe(groupeId);
    } else {
        // Mode cr√©ation
        document.getElementById('modalGroupeTitle').textContent = 'Nouveau Groupe';
        reinitialiserFormulaire();
    }
    
    chargerSocietes();
    modal.show();
}

function chargerGroupe(groupeId) {
    fetch(`/admin/groupes-utilisateurs/${groupeId}`)
        .then(response => response.json())
        .then(data => {
            groupeEnCours = data.id;
            
            // Remplir le formulaire
            document.getElementById('groupeNom').value = data.nom;
            document.getElementById('groupeDescription').value = data.description || '';
            document.getElementById('groupeNiveau').value = data.niveau;
            document.getElementById('groupeCouleur').value = data.couleur || '#6c757d';
            document.getElementById('groupeParent').value = data.parent_id || '';
            document.getElementById('groupeActif').checked = data.actif;
            
            // Cocher les permissions
            document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
                checkbox.checked = data.permissions.includes(checkbox.value);
            });
            
            // Les soci√©t√©s seront coch√©es apr√®s chargement de la liste
            setTimeout(() => {
                if (data.societes.length === 0) {
                    // Aucune soci√©t√© sp√©cifique = acc√®s global
                    document.getElementById('societe_all').checked = true;
                    toggleAllSocietes(true);
                } else {
                    // Cocher les soci√©t√©s sp√©cifiques
                    data.societes.forEach(societe => {
                        const checkbox = document.getElementById(`societe_${societe.id}`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            }, 200);
        })
        .catch(error => {
            console.error('Erreur lors du chargement du groupe:', error);
            showNotification('Erreur lors du chargement du groupe', 'error');
        });
}

function chargerSocietes() {
    const societesList = document.getElementById('societesList');
    
    // Afficher le chargement
    societesList.innerHTML = `
        <div class="d-flex justify-content-center align-items-center py-3">
            <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
            <span class="text-muted">Chargement des soci√©t√©s...</span>
        </div>
    `;
    
    // Charger les soci√©t√©s via l'API
    fetch('/admin/api/societes-tree')
        .then(response => response.json())
        .then(societes => {
            console.log('=== API SOCIETES-TREE RESPONSE ===');
            console.log('Nombre de soci√©t√©s:', societes.length);
            
            if (societes.length === 0) {
                societesList.innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-building fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Aucune soci√©t√© disponible</p>
                    </div>
                `;
                return;
            }
            
            // Construire l'arbre g√©n√©alogique
            let html = `
                <div class="societes-tree">
                    <div class="mb-3 p-3 bg-light rounded border">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="societe_all" onchange="toggleAllSocietes(this.checked)">
                            <label class="form-check-label fw-bold text-primary d-flex align-items-center" for="societe_all">
                                <i class="fas fa-globe me-2"></i>
                                <span>Toutes les soci√©t√©s (acc√®s global)</span>
                            </label>
                            <small class="text-muted d-block mt-1">Cocher cette option donne acc√®s √† toutes les soci√©t√©s</small>
                        </div>
                    </div>
                    
                    <div class="societes-list border rounded" style="background-color: #fafafa;">
                        <div class="p-2 bg-white border-bottom">
                            <small class="text-muted fw-medium">
                                <i class="fas fa-sitemap me-1"></i>S√©lection par soci√©t√©
                            </small>
                        </div>
                        <div class="p-2">
            `;
            
            societes.forEach(societe => {
                html += renderSocieteNode(societe, 0);
            });
            
            html += `
                        </div>
                    </div>
                </div>
            `;
            
            societesList.innerHTML = html;
            
            // Debug: V√©rifier les data attributes
            setTimeout(() => {
                console.log('=== DEBUG SOCI√âT√â TREE ===');
                document.querySelectorAll('.societe-checkbox').forEach(checkbox => {
                    console.log('Checkbox:', checkbox.id, {
                        children: checkbox.dataset.children,
                        parent: checkbox.dataset.parent,
                        hasChildren: !!checkbox.dataset.children,
                        hasParent: !!checkbox.dataset.parent,
                        element: checkbox
                    });
                });
                
                // Test manuel de la cascade
                console.log('=== TEST MANUEL CASCADE ===');
                const parentCheckboxes = document.querySelectorAll('.societe-checkbox[data-children]');
                console.log('Soci√©t√©(s) m√®re(s) trouv√©e(s):', parentCheckboxes.length);
                parentCheckboxes.forEach((checkbox, index) => {
                    console.log(`Soci√©t√© m√®re ${index + 1}:`, checkbox.id, 'enfants:', checkbox.dataset.children);
                });
                
                // Cr√©er une fonction de test globale
                window.testCascade = function() {
                    console.log('=== TEST FORCE CASCADE ===');
                    const parentCheckbox = document.querySelector('.societe-checkbox[data-children]');
                    if (parentCheckbox) {
                        console.log('Test avec soci√©t√© m√®re:', parentCheckbox.id);
                        parentCheckbox.checked = true;
                        onSocieteToggle(parentCheckbox);
                    } else {
                        console.log('Aucune soci√©t√© m√®re trouv√©e avec data-children');
                    }
                };
                
                console.log('Fonction testCascade() cr√©√©e. Utilisez testCascade() dans la console.');
            }, 100);
        })
        .catch(error => {
            console.error('Erreur lors du chargement des soci√©t√©s:', error);
            societesList.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    Erreur lors du chargement des soci√©t√©s
                </div>
            `;
        });
}

function renderSocieteNode(societe, level) {
    const indent = level * 20;
    const typeIcon = societe.type === 'mere' ? 'fas fa-building' : 'far fa-building';
    const typeBadge = societe.type === 'mere' ? 
        '<span class="badge bg-primary ms-1">M√®re</span>' : 
        '<span class="badge bg-secondary ms-1">Fille</span>';
    
    // Construire les data attributes pour la cascade
    const isParent = societe.enfants && societe.enfants.length > 0;
    const childrenIds = isParent ? societe.enfants.map(e => e.id).join(',') : '';
    
    console.log('Rendu soci√©t√©:', societe.nom, 'isParent:', isParent, 'childrenIds:', childrenIds, 'parent_id:', societe.parent_id);
    
    let html = `
        <div class="societe-item mb-1">
            <div class="form-check d-flex align-items-center p-2 rounded" 
                 style="margin-left: ${indent}px; background-color: ${level > 0 ? '#f8f9fa' : 'white'}; border-left: ${level > 0 ? '3px solid #dee2e6' : 'none'}; border: 1px solid #dee2e6;">
                <input class="form-check-input societe-checkbox me-2" 
                       type="checkbox" 
                       id="societe_${societe.id}" 
                       value="${societe.id}"
                       ${isParent ? `data-children="${childrenIds}"` : ''}
                       ${societe.parent_id ? `data-parent="${societe.parent_id}"` : ''}
                       onchange="onSocieteToggle(this)">
                <label class="form-check-label d-flex align-items-center flex-grow-1 mb-0" for="societe_${societe.id}">
                    <i class="${typeIcon} me-2 text-${societe.type === 'mere' ? 'primary' : 'secondary'}"></i>
                    <span class="fw-medium">${societe.display_name || societe.nom}</span>
                    ${typeBadge}
                    ${isParent ? `<small class="text-muted ms-2">(${societe.enfants.length} filiale${societe.enfants.length > 1 ? 's' : ''})</small>` : ''}
                </label>
            </div>
        </div>
    `;
    
    // Ajouter les enfants de mani√®re r√©cursive
    if (societe.enfants && societe.enfants.length > 0) {
        societe.enfants.forEach(enfant => {
            html += renderSocieteNode(enfant, level + 1);
        });
    }
    
    return html;
}

function onSocieteToggle(checkbox, preventRecursion = false) {
    const isChecked = checkbox.checked;
    const childrenIds = checkbox.dataset.children;
    const parentId = checkbox.dataset.parent;
    
    console.log('Toggle soci√©t√©:', checkbox.id, 'checked:', isChecked, 'children:', childrenIds, 'parent:', parentId, 'preventRecursion:', preventRecursion);
    
    // Si c'est une soci√©t√© m√®re, cocher/d√©cocher automatiquement les filiales
    if (childrenIds && childrenIds.trim() !== '' && !preventRecursion) {
        const children = childrenIds.split(',');
        console.log('Enfants √† traiter:', children);
        children.forEach(childId => {
            if (childId.trim() !== '') {
                const childCheckbox = document.getElementById(`societe_${childId.trim()}`);
                console.log('Recherche enfant:', `societe_${childId.trim()}`, 'trouv√©:', !!childCheckbox);
                if (childCheckbox) {
                    const oldChecked = childCheckbox.checked;
                    childCheckbox.checked = isChecked;
                    console.log('Enfant', childId, 'mis √† jour de', oldChecked, 'vers', isChecked);
                    
                    // Propager aux petits-enfants s'il y en a (avec protection r√©cursion)
                    if (childCheckbox.dataset.children && childCheckbox.dataset.children.trim() !== '') {
                        console.log('Propagation r√©cursive pour:', childId);
                        onSocieteToggle(childCheckbox, true);
                    }
                }
            }
        });
    }
    
    // Si c'est une filiale d√©coch√©e, d√©cocher la soci√©t√© m√®re
    if (parentId && !isChecked && !preventRecursion) {
        const parentCheckbox = document.getElementById(`societe_${parentId}`);
        if (parentCheckbox && parentCheckbox.checked) {
            parentCheckbox.checked = false;
            console.log('Parent d√©coch√©:', parentId);
        }
    }
    
    // Si c'est une filiale coch√©e, v√©rifier si toutes les filiales sont coch√©es pour cocher la m√®re
    if (parentId && isChecked && !preventRecursion) {
        const parentCheckbox = document.getElementById(`societe_${parentId}`);
        if (parentCheckbox && !parentCheckbox.checked && parentCheckbox.dataset.children) {
            const siblingIds = parentCheckbox.dataset.children.split(',');
            const allSiblingsChecked = siblingIds.every(siblingId => {
                const siblingCheckbox = document.getElementById(`societe_${siblingId.trim()}`);
                return siblingCheckbox && siblingCheckbox.checked;
            });
            
            if (allSiblingsChecked) {
                parentCheckbox.checked = true;
                console.log('Parent auto-coch√©:', parentId);
            }
        }
    }
    
    // Mettre √† jour la s√©lection globale
    if (!preventRecursion) {
        updateSocieteSelection();
    }
}

function toggleAllSocietes(checked) {
    const allCheckboxes = document.querySelectorAll('.societe-checkbox');
    allCheckboxes.forEach(checkbox => {
        checkbox.checked = checked;
    });
    
    // Afficher/masquer la liste des soci√©t√©s
    const societesList = document.querySelector('.societes-list');
    if (societesList) {
        societesList.style.opacity = checked ? '0.5' : '1';
        societesList.style.pointerEvents = checked ? 'none' : 'auto';
    }
}

function updateSocieteSelection() {
    const allCheckbox = document.getElementById('societe_all');
    const societeCheckboxes = document.querySelectorAll('.societe-checkbox');
    const checkedSocietes = document.querySelectorAll('.societe-checkbox:checked');
    
    // Si toutes les soci√©t√©s sont s√©lectionn√©es, cocher "Toutes les soci√©t√©s"
    if (checkedSocietes.length === societeCheckboxes.length && societeCheckboxes.length > 0) {
        allCheckbox.checked = true;
        toggleAllSocietes(true);
    } else {
        // Si on d√©coche une soci√©t√©, d√©cocher "Toutes les soci√©t√©s"
        if (allCheckbox.checked) {
            allCheckbox.checked = false;
            const societesList = document.querySelector('.societes-list');
            if (societesList) {
                societesList.style.opacity = '1';
                societesList.style.pointerEvents = 'auto';
            }
        }
    }
}

function reinitialiserFormulaire() {
    groupeEnCours = null;
    document.getElementById('formGroupe').reset();
    document.getElementById('groupeNiveau').value = 5;
    document.getElementById('groupeCouleur').value = '#6c757d';
    document.getElementById('groupeActif').checked = true;
    
    // D√©cocher toutes les permissions
    document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
}

function sauvegarderGroupe() {
    const formData = new FormData(document.getElementById('formGroupe'));
    
    // Collecter les permissions s√©lectionn√©es
    const permissions = Array.from(document.querySelectorAll('.permission-checkbox:checked'))
        .map(checkbox => checkbox.value);
    
    // Collecter les soci√©t√©s s√©lectionn√©es
    const allSocietesChecked = document.getElementById('societe_all').checked;
    let societes = [];
    
    if (allSocietesChecked) {
        // Si "toutes les soci√©t√©s" est coch√©, renvoyer un tableau vide (acc√®s global)
        societes = [];
    } else {
        // Sinon, collecter les soci√©t√©s sp√©cifiquement s√©lectionn√©es
        societes = Array.from(document.querySelectorAll('.societe-checkbox:checked'))
            .map(checkbox => parseInt(checkbox.value));
    }
    
    const data = {
        nom: formData.get('nom'),
        description: formData.get('description'),
        niveau: parseInt(formData.get('niveau')),
        couleur: formData.get('couleur'),
        parent_id: formData.get('parent_id') || null,
        actif: document.getElementById('groupeActif').checked,
        permissions: permissions,
        societes: societes
    };
    
    if (groupeEnCours) {
        data.ordre = parseInt(document.querySelector(`tr[data-groupe-id="${groupeEnCours}"] .badge`).textContent);
    }
    
    const url = groupeEnCours ? 
        `/admin/groupes-utilisateurs/${groupeEnCours}` : 
        '/admin/groupes-utilisateurs';
    const method = groupeEnCours ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('modalGroupe')).hide();
            rechargerTableauGroupes();
        } else {
            showNotification(data.error || 'Erreur lors de la sauvegarde', 'error');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('Erreur lors de la communication avec le serveur', 'error');
    });
}

function voirGroupe(groupeId) {
    const modal = new bootstrap.Modal(document.getElementById('modalGroupe'));
    
    // Mode consultation - charger les donn√©es mais en lecture seule
    document.getElementById('modalGroupeTitle').textContent = 'D√©tails du Groupe';
    chargerGroupe(groupeId);
    
    // Attendre que les donn√©es soient charg√©es puis d√©sactiver
    setTimeout(() => {
        document.querySelectorAll('#modalGroupe input, #modalGroupe textarea, #modalGroupe select').forEach(field => {
            field.readOnly = true;
            field.disabled = true;
        });
        document.querySelectorAll('#modalGroupe .form-check-input').forEach(checkbox => {
            checkbox.disabled = true;
        });
        
        // Masquer le bouton sauvegarder et changer le bouton fermer
        const modalFooter = document.querySelector('#modalGroupe .modal-footer');
        modalFooter.innerHTML = `
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        `;
    }, 200);
    
    modal.show();
    
    // Restaurer le modal apr√®s fermeture
    document.getElementById('modalGroupe').addEventListener('hidden.bs.modal', function() {
        const modalFooter = document.querySelector('#modalGroupe .modal-footer');
        modalFooter.innerHTML = `
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="button" class="btn btn-primary" onclick="sauvegarderGroupe()">
                <i class="fas fa-save me-1"></i>Sauvegarder
            </button>
        `;
        
        // R√©activer tous les champs
        document.querySelectorAll('#modalGroupe input, #modalGroupe textarea, #modalGroupe select').forEach(field => {
            field.readOnly = false;
            field.disabled = false;
        });
        document.querySelectorAll('#modalGroupe .form-check-input').forEach(checkbox => {
            checkbox.disabled = false;
        });
    }, { once: true });
}

function modifierGroupe(groupeId) {
    ouvrirModalGroupe(groupeId);
}

function toggleGroupe(groupeId) {
    fetch(`/admin/groupes-utilisateurs/${groupeId}/toggle`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            rechargerTableauGroupes();
        } else {
            showNotification(data.error || 'Erreur lors du changement de statut', 'error');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('Erreur lors de la communication avec le serveur', 'error');
    });
}

function supprimerGroupe(groupeId) {
    const row = document.querySelector(`tr[data-groupe-id="${groupeId}"]`);
    const nomGroupe = row.querySelector('strong').textContent;
    
    document.getElementById('messageConfirmation').textContent = 
        `√ätes-vous s√ªr de vouloir supprimer le groupe "${nomGroupe}" ? Cette action est irr√©versible.`;
    
    const modal = new bootstrap.Modal(document.getElementById('modalConfirmation'));
    modal.show();
    
    document.getElementById('btnConfirmer').onclick = function() {
        fetch(`/admin/groupes-utilisateurs/${groupeId}`, {
            method: 'DELETE',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                rechargerTableauGroupes();
            } else {
                showNotification(data.error || 'Erreur lors de la suppression', 'error');
            }
            modal.hide();
        })
        .catch(error => {
            console.error('Erreur:', error);
            showNotification('Erreur lors de la communication avec le serveur', 'error');
        });
    };
}

function reorganiserOrdres() {
    fetch('/admin/groupes-utilisateurs/reorganize', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Ordres r√©organis√©s avec succ√®s', 'success');
            rechargerTableauGroupes();
        } else {
            showNotification('Erreur lors de la r√©organisation', 'error');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('Erreur lors de la communication avec le serveur', 'error');
    });
}

function filtrerGroupes(searchTerm) {
    const rows = document.querySelectorAll('#tableGroupes tbody tr');
    const term = searchTerm.toLowerCase();
    
    rows.forEach(row => {
        const nom = row.querySelector('strong').textContent.toLowerCase();
        const description = row.querySelector('.text-muted').textContent.toLowerCase();
        
        if (nom.includes(term) || description.includes(term)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function rechargerTableauGroupes() {
    // Recharger uniquement la section des groupes
    fetch('/admin/groupes-utilisateurs')
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const newDoc = parser.parseFromString(html, 'text/html');
            const newContent = newDoc.querySelector('.admin-section');
            
            if (newContent) {
                document.querySelector('.admin-section').replaceWith(newContent);
                // R√©initialiser les event listeners
                document.addEventListener('DOMContentLoaded', function() {
                    document.getElementById('searchGroupe').addEventListener('input', function() {
                        filtrerGroupes(this.value);
                    });
                });
            }
        })
        .catch(error => {
            console.error('Erreur lors du rechargement:', error);
            window.location.reload(); // Fallback
        });
}

function showNotification(message, type = 'info') {
    // Utiliser le syst√®me de notification existant ou cr√©er une notification simple
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-danger' : 'alert-info';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}
</script>

<style>
/* Styles pour l'arbre g√©n√©alogique des soci√©t√©s */
.societes-tree {
    max-height: 400px;
    overflow-y: auto;
}

.societes-list {
    max-height: 280px;
    overflow-y: auto;
}

.societe-item {
    position: relative;
    transition: all 0.2s ease;
}

.societe-item .form-check {
    transition: all 0.2s ease;
    border: 1px solid transparent;
}

.societe-item .form-check:hover {
    background-color: #fff !important;
    border-color: #dee2e6 !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.societe-item .form-check-input:checked + .form-check-label {
    color: #0d6efd;
}

.societe-item .form-check-input:checked + .form-check-label .badge {
    opacity: 1;
    transform: scale(1.05);
}

.societe-item .form-check-label .badge {
    opacity: 0.8;
    transition: all 0.2s ease;
    font-size: 0.7rem;
}

.societe-item .form-check-label:hover .badge {
    opacity: 1;
}

/* Lignes de connexion hi√©rarchique */
.societe-item .form-check {
    position: relative;
    width: 100%;
    box-sizing: border-box;
}

/* Indicateurs de soci√©t√© m√®re */
.societe-item input[data-children] + .form-check-label {
    font-weight: 600;
    color: #0d6efd;
}

.societe-item input[data-children] + .form-check-label::after {
    content: 'üë•';
    margin-left: 8px;
    font-size: 0.8rem;
}

/* S'assurer que les √©l√©ments restent dans le conteneur */
.societes-list .p-2 {
    overflow-x: hidden;
}

.societe-item .form-check {
    max-width: 100%;
    box-sizing: border-box;
}

/* Animation pour les soci√©t√©s s√©lectionn√©es */
.societe-item .form-check-input:checked + .form-check-label {
    animation: pulse 0.3s ease;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

/* Style sp√©cial pour l'option "Toutes les soci√©t√©s" */
.societes-tree .mb-3 .form-check {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border: 1px solid #90caf9 !important;
    transition: all 0.2s ease;
}

.societes-tree .mb-3 .form-check:hover {
    background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
</style>