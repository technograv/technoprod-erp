{% extends 'base.html.twig' %}

{% block title %}Modifier Devis {{ devis.numeroDevis }}{% endblock %}

{% block body %}
<!-- Messages Flash -->
{% for type, messages in app.flashes %}
    {% for message in messages %}
        <div class="alert alert-{{ type == 'error' ? 'danger' : (type == 'warning' ? 'warning' : (type == 'info' ? 'info' : 'success')) }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
{% endfor %}

<!-- En-tête -->
<div class="page-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-1"><i class="fas fa-edit me-3"></i>Modifier Devis {{ devis.numeroDevis }}</h1>
                <p class="mb-0">
                    <span class="badge bg-{{ devis.statutCouleur }} status-badge">{{ devis.statutLibelle }}</span>
                    {% if devis.client %}
                        <span class="ms-2">{{ devis.client.nomComplet }}</span>
                    {% endif %}
                </p>
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group">
                    <a href="{{ path('app_devis_show', {'id': devis.id}) }}" class="btn btn-light">
                        <i class="fas fa-eye"></i> Voir le devis
                    </a>
                    <a href="{{ path('app_devis_index') }}" class="btn btn-outline-light">
                        <i class="fas fa-arrow-left"></i> Retour à la liste
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    {{ form_start(form, {'attr': {'id': 'devis-form', 'class': 'devis-form'}}) }}
    
    <div class="row">
        <div class="col-12">
            <!-- Informations générales -->
            <div class="form-section">
                <div class="form-section-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informations générales</h5>
                </div>
                <div class="form-section-body">
                    <div class="row">
                        <div class="col-md-6">
                            {{ form_row(form.client, {
                                'label': 'Client / Prospect *',
                                'attr': {
                                    'class': 'form-select prospect-select',
                                    'data-placeholder': 'Sélectionnez un client ou prospect'
                                }
                            }) }}
                        </div>
                        <div class="col-md-6">
                            {{ form_row(form.commercial, {
                                'label': 'Commercial',
                                'attr': {'class': 'form-select'}
                            }) }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            {{ form_row(form.numeroDevis, {
                                'label': 'Numéro de devis',
                                'attr': {'class': 'form-control', 'readonly': true}
                            }) }}
                        </div>
                        <div class="col-md-3">
                            {{ form_row(form.dateCreation, {
                                'label': 'Date de création',
                                'attr': {'class': 'form-control'}
                            }) }}
                        </div>
                        <div class="col-md-3">
                            {{ form_row(form.dateValidite, {
                                'label': 'Date de validité',
                                'attr': {'class': 'form-control'}
                            }) }}
                        </div>
                        <div class="col-md-3">
                            {{ form_row(form.statut, {
                                'label': 'Statut',
                                'attr': {'class': 'form-select'}
                            }) }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Adresses et contacts -->
            <div class="form-section">
                <div class="form-section-header">
                    <h5 class="mb-0"><i class="fas fa-address-card me-2"></i>Adresses et contacts</h5>
                </div>
                <div class="form-section-body">
                    <div class="row">
                        <div class="col-md-6">
                            {{ form_row(form.contactFacturation, {
                                'label': 'Contact facturation',
                                'attr': {'class': 'form-select'}
                            }) }}
                            {{ form_row(form.adresseFacturation, {
                                'label': 'Adresse facturation',
                                'attr': {'class': 'form-select'}
                            }) }}
                        </div>
                        <div class="col-md-6">
                            {{ form_row(form.contactLivraison, {
                                'label': 'Contact livraison',
                                'attr': {'class': 'form-select'}
                            }) }}
                            {{ form_row(form.adresseLivraison, {
                                'label': 'Adresse livraison',
                                'attr': {'class': 'form-select'}
                            }) }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lignes de devis -->
            <div class="form-section">
                <div class="form-section-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Lignes de devis</h5>
                    </div>
                </div>
                <div class="form-section-body">
                    <!-- En-têtes colonnes parfaitement alignés -->
                    <div class="d-flex devis-headers mb-2 py-2 bg-light rounded align-items-start" style="gap: 2px; height: 35px;">
                        <div style="width: 120px; padding: 4px;"><small class="fw-bold">Code</small></div>
                        <div style="width: 225px; padding: 4px;"><small class="fw-bold">Désignation</small></div>
                        <div class="flex-fill" style="padding: 4px;"><small class="fw-bold">Description détaillée</small></div>
                        <div style="width: 90px; padding: 4px;" class="text-center"><small class="fw-bold">Qté</small></div>
                        <div style="width: 120px; padding: 4px;" class="text-center"><small class="fw-bold">PU HT</small></div>
                        <div style="width: 90px; padding: 4px;" class="text-center"><small class="fw-bold">% Rem.</small></div>
                        <div style="width: 105px; padding: 4px;" class="text-center"><small class="fw-bold">TVA</small></div>
                        <div style="width: 80px; padding: 4px;" class="text-center"><small class="fw-bold">Total HT</small></div>
                        {% if devis.statut == 'brouillon' %}
                        <div style="width: 30px; padding: 4px;"><small class="fw-bold"></small></div>
                        {% endif %}
                    </div>

                    <div class="devis-items-collection" id="devis_devisItems" data-prototype="{{ form_row(form.devisItems.vars.prototype)|e('html_attr') }}" data-index="{{ form.devisItems|length }}">
                        {% for item in form.devisItems %}
                            <div class="devis-item mb-1 border-bottom">
                                <div class="d-flex align-items-start" style="gap: 2px; min-height: 35px;">
                                    <!-- Code article (1,5x = 120px) -->
                                    <div style="width: 120px; padding: 4px;">
                                        <input type="text" class="form-control form-control-sm code-article-input" 
                                               placeholder="Code..." readonly value="{{ item.vars.data.produit ? item.vars.data.produit.reference : '' }}" />
                                    </div>
                                    
                                    <!-- Désignation (1,5x = 225px) -->
                                    <div style="width: 225px; padding: 4px;">
                                        {{ form_widget(item.designation, {'attr': {'class': 'form-control form-control-sm designation-input'}}) }}
                                    </div>
                                    
                                    <!-- Description détaillée (espace restant) -->
                                    <div class="flex-fill" style="padding: 4px;">
                                        {{ form_widget(item.description, {'attr': {'class': 'form-control form-control-sm description-input', 'placeholder': 'Description détaillée...'}}) }}
                                    </div>
                                    
                                    <!-- Quantité (1,5x = 90px) -->
                                    <div style="width: 90px; padding: 4px;">
                                        {{ form_widget(item.quantite, {'attr': {'class': 'form-control form-control-sm text-center quantity-input'}}) }}
                                    </div>
                                    
                                    <!-- Prix unitaire HT sans € (1,5x = 120px) -->
                                    <div style="width: 120px; padding: 4px;">
                                        {{ form_widget(item.prixUnitaireHt, {'attr': {'class': 'form-control form-control-sm text-end price-input', 'placeholder': '0.00'}}) }}
                                    </div>
                                    
                                    <!-- % Remise (1,5x = 90px) -->
                                    <div style="width: 90px; padding: 4px;">
                                        {{ form_widget(item.remisePercent, {'attr': {'class': 'form-control form-control-sm text-center remise-input', 'placeholder': '0.0', 'step': '0.1'}}) }}
                                    </div>
                                    
                                    <!-- TVA (1,5x = 105px) -->
                                    <div style="width: 105px; padding: 4px;">
                                        <select class="form-select form-select-sm tva-select" name="{{ item.tvaPercent.vars.full_name }}" data-current-value="{{ item.vars.data.tvaPercent ?? '20.00' }}">
                                            <!-- Options seront chargées via JavaScript depuis admin -->
                                        </select>
                                    </div>
                                    
                                    <!-- Total HT ligne -->
                                    <div style="width: 80px; padding: 4px;" class="text-center">
                                        <small class="total-ligne-display fw-bold text-success" style="font-size: 0.75rem; line-height: 23px;">{{ item.vars.data.totalLigneHt ?? '0.00' }}€</small>
                                    </div>
                                    
                                    <!-- Action -->
                                    {% if devis.statut == 'brouillon' %}
                                    <div style="width: 30px; padding: 4px;" class="text-center">
                                        <button type="button" class="btn btn-outline-danger btn-sm remove-item-btn" title="Supprimer" style="padding: 2px 4px; font-size: 10px;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    {% endif %}
                                </div>
                                {# Masquer les champs restants pour éviter les doublons #}
                                <div style="display: none;">
                                    {{ form_widget(item.produit) }}
                                    {{ form_widget(item.ordreAffichage) }}
                                    {{ form_widget(item.totalLigneHt) }}
                                    {{ form_widget(item.remiseMontant) }}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Boutons pour ajouter une ligne -->
                    {% if devis.statut == 'brouillon' %}
                        <div class="mt-3 text-center">
                            <button type="button" class="btn btn-success add-item-btn me-2">
                                <i class="fas fa-plus me-2"></i>Ajouter une ligne libre
                            </button>
                            <button type="button" class="btn btn-outline-success catalogue-product-btn">
                                <i class="fas fa-book me-2"></i>Nouveau produit du catalogue
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Conditions commerciales -->
            <div class="form-section">
                <div class="form-section-header">
                    <h5 class="mb-0"><i class="fas fa-handshake me-2"></i>Conditions commerciales</h5>
                </div>
                <div class="form-section-body">
                    <div class="row">
                        <div class="col-md-6">
                            {{ form_row(form.acomptePercent, {
                                'label': 'Acompte (%)',
                                'attr': {'class': 'form-control', 'min': 0, 'max': 100, 'step': 0.01}
                            }) }}
                        </div>
                        <div class="col-md-6">
                            {{ form_row(form.acompteMontant, {
                                'label': 'Acompte (montant fixe)',
                                'attr': {'class': 'form-control', 'min': 0, 'step': 0.01}
                            }) }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            {{ form_row(form.remiseGlobalePercent, {
                                'label': 'Remise globale (%)',
                                'attr': {'class': 'form-control', 'min': 0, 'max': 100, 'step': 0.01}
                            }) }}
                        </div>
                        <div class="col-md-6">
                            {{ form_row(form.delaiLivraison, {
                                'label': 'Délai de livraison',
                                'attr': {'class': 'form-control', 'placeholder': 'Ex: 2-3 semaines'}
                            }) }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            {{ form_row(form.notesClient, {
                                'label': 'Notes client',
                                'attr': {'class': 'form-control', 'rows': 3, 'placeholder': 'Notes visibles par le client'}
                            }) }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historique -->
            <div class="form-section">
                <div class="form-section-header">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Historique</h5>
                </div>
                <div class="form-section-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Créé le :</strong> {{ devis.createdAt|date('d/m/Y à H:i') }}</p>
                            {% if devis.dateEnvoi %}
                                <p><strong>Envoyé le :</strong> {{ devis.dateEnvoi|date('d/m/Y à H:i') }}</p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            {% if devis.updatedAt %}
                                <p><strong>Modifié le :</strong> {{ devis.updatedAt|date('d/m/Y à H:i') }}</p>
                            {% endif %}
                            {% if devis.dateSignature %}
                                <p><strong>Signé le :</strong> {{ devis.dateSignature|date('d/m/Y à H:i') }}</p>
                                <p><strong>Par :</strong> {{ devis.signatureNom }} ({{ devis.signatureEmail }})</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <!-- Message d'alerte pour devis envoyé -->
            {% if devis.statut in ['envoye', 'signe'] %}
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Attention :</strong> Ce devis a déjà été envoyé. 
                    Toute modification créera automatiquement une version pour conserver l'historique.
                </div>
            {% endif %}
        </div>
    </div>

    {{ form_rest(form) }}
    {{ form_end(form) }}
</div>

<!-- Panneau récapitulatif flottant -->
<div class="floating-summary" id="floating-summary">
    <div class="floating-summary-toggle" id="summary-toggle">
        <i class="fas fa-calculator me-2"></i>
        <span class="summary-total-display">{{ devis.totalTtc }}€ TTC</span>
        <i class="fas fa-chevron-up toggle-icon"></i>
    </div>
    <div class="floating-summary-content" id="summary-content">
        <div class="row">
            <div class="col-md-3">
                <div class="summary-item">
                    <span class="summary-label">Total HT :</span>
                    <span class="summary-value total-ht">{{ devis.totalHt }}€</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-item">
                    <span class="summary-label">TVA :</span>
                    <span class="summary-value total-tva">{{ devis.totalTva }}€</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-item">
                    <span class="summary-label">Total TTC :</span>
                    <span class="summary-value total-ttc fw-bold text-success">{{ devis.totalTtc }}€</span>
                </div>
            </div>
            {% if devis.acomptePercent or devis.acompteMontant %}
            <div class="col-md-3">
                <div class="summary-item">
                    <span class="summary-label">Acompte :</span>
                    <span class="summary-value acompte-montant">{{ devis.calculateAcompte }}€</span>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Barre flottante d'actions -->
<div class="floating-action-bar" id="floating-actions">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span class="text-white me-3">
                    <i class="fas fa-file-invoice me-2"></i>
                    <strong>{{ devis.numeroDevis }}</strong>
                    <span class="badge bg-{{ devis.statutCouleur }} ms-2">{{ devis.statutLibelle }}</span>
                </span>
            </div>
            <div class="d-flex gap-2">
                <button type="submit" name="action" value="save" class="btn btn-light" form="devis-form">
                    <i class="fas fa-save me-1"></i>
                    {% if devis.statut in ['envoye', 'signe'] %}
                        Modifier et créer une version
                    {% else %}
                        Enregistrer les modifications
                    {% endif %}
                </button>
                
                {% if devis.statut == 'brouillon' %}
                    <button type="submit" name="action" value="save_and_send" class="btn btn-success" form="devis-form">
                        <i class="fas fa-paper-plane me-1"></i>Enregistrer et envoyer
                    </button>
                {% endif %}
                
                <a href="{{ path('app_devis_pdf', {'id': devis.id}) }}" target="_blank" class="btn btn-info">
                    <i class="fas fa-file-pdf me-1"></i>PDF
                </a>
                
                <a href="{{ path('app_devis_show', {'id': devis.id}) }}" class="btn btn-secondary">
                    <i class="fas fa-eye me-1"></i>Voir
                </a>
                
                <a href="{{ path('app_devis_index') }}" class="btn btn-outline-light">
                    <i class="fas fa-times me-1"></i>Annuler
                </a>
            </div>
        </div>
    </div>
</div>

{% block stylesheets %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet">
    <style>
        .page-header {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
        }
        .form-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        .form-section-header {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            border-radius: 8px 8px 0 0;
            padding: 1rem 1.5rem;
            font-weight: 600;
        }
        .form-section-body {
            padding: 1.5rem;
        }
        
        /* Alignement parfait des lignes de devis */
        .devis-item .d-flex > div {
            display: flex;
            align-items: flex-start !important;
        }
        
        .devis-item .form-control,
        .devis-item .form-select {
            margin: 0 !important;
            padding-top: 0.25rem !important;
            padding-bottom: 0.25rem !important;
            height: 31px !important;
            line-height: 1.2 !important;
        }
        
        .devis-headers > div,
        .devis-item .d-flex > div {
            vertical-align: top !important;
            display: flex !important;
            align-items: flex-start !important;
        }
        
        /* Forcer l'alignement des en-têtes avec les colonnes */
        .devis-headers {
            border: 1px solid #dee2e6;
        }
        
        .devis-headers > div {
            border-right: 1px solid #e9ecef;
            padding-left: 4px !important;
            padding-right: 4px !important;
        }
        
        .devis-item .d-flex > div {
            border-right: 1px solid rgba(0,0,0,0.05);
            padding-left: 4px !important;
            padding-right: 4px !important;
        }
        /* Barre flottante d'actions */
        .floating-action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1050;
            padding: 12px 0;
        }
        
        /* Lignes de devis compactes */
        .devis-item {
            transition: background-color 0.2s;
        }
        
        .devis-item:hover {
            background-color: #f8f9fa;
        }
        
        .devis-headers {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        /* Ajustement pour éviter que le contenu passe sous les barres flottantes */
        body {
            padding-bottom: 140px; /* Augmenté pour la double barre */
        }
        
        /* Panneau récapitulatif flottant */
        .floating-summary {
            position: fixed;
            bottom: 70px; /* Au-dessus de la barre d'actions */
            right: 20px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1040;
            min-width: 320px;
            max-width: 600px;
        }
        
        .floating-summary-toggle {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .floating-summary-toggle:hover {
            background: linear-gradient(135deg, #218838 0%, #1fa085 100%);
        }
        
        .floating-summary-content {
            padding: 16px;
            border-radius: 0 0 8px 8px;
            display: none; /* Caché par défaut */
        }
        
        .floating-summary.expanded .floating-summary-content {
            display: block;
        }
        
        .floating-summary.expanded .toggle-icon {
            transform: rotate(180deg);
        }
        
        .toggle-icon {
            transition: transform 0.2s;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #f8f9fa;
        }
        
        .summary-item:last-child {
            border-bottom: none;
        }
        
        .summary-label {
            color: #6c757d;
            font-size: 0.875rem;
        }
        
        .summary-value {
            font-weight: 600;
            color: #495057;
        }
        
        .summary-total-display {
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        /* Champs compacts */
        .form-control-sm {
            font-size: 0.875rem;
        }
        
        /* Totaux mis en évidence */
        .total-display, .total-ligne-display {
            font-weight: 600;
            color: #198754;
        }
        
        /* Responsive pour écrans plus petits */
        @media (max-width: 768px) {
            .floating-action-bar .d-flex {
                flex-direction: column;
                gap: 8px;
            }
            .floating-action-bar {
                padding: 8px 0;
            }
        }
    </style>
{% endblock %}

{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


<script>
$(document).ready(function() {
    // Désactiver la modification des lignes si le devis n'est pas en brouillon
    {% if devis.statut != 'brouillon' %}
        $('.devis-item input, .devis-item select, .devis-item textarea').each(function() {
            $(this).attr('readonly', true).attr('disabled', true);
        });
        
        // Masquer les boutons d'ajout/suppression
        $('.add-item-btn, .remove-item-btn').hide();
        
        // Message d'information
        const info = $('<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>Ce devis a été envoyé. Les modifications créeront une version pour conserver l\'historique.</div>');
        $('.devis-items-collection').before(info);
    {% else %}
    
    // Gestion de la collection de lignes de devis (seulement si brouillon)
    const $collectionHolder = $('#devis_devisItems');
    let index = $collectionHolder.find('.devis-item').length;

    function addNewDevisItem() {
        // Protection contre les doubles appels
        if (window.addingInProgress) {
            return;
        }
        window.addingInProgress = true;
        
        // Utiliser le prototype du formulaire Symfony
        const prototype = $collectionHolder.data('prototype');
        const newForm = prototype.replace(/__name__/g, index);
        index++;

        const $newItem = $('<div class="devis-item"></div>').html(newForm);
        
        // Créer une nouvelle ligne parfaitement alignée avec les en-têtes
        const $newItemCompact = $(`
        <div class="devis-item mb-1 border-bottom" data-index="${index}">
            <div class="d-flex align-items-start" style="gap: 2px; min-height: 35px;">
                <!-- Code article (1,5x = 120px) -->
                <div style="width: 120px; padding: 4px;">
                    <input type="text" class="form-control form-control-sm code-article-input" placeholder="Code..." />
                </div>
                
                <!-- Désignation (1,5x = 225px) -->
                <div style="width: 225px; padding: 4px;">
                </div>
                
                <!-- Description détaillée (espace restant) -->
                <div class="flex-fill" style="padding: 4px;">
                </div>
                
                <!-- Quantité (1,5x = 90px) -->
                <div style="width: 90px; padding: 4px;">
                </div>
                
                <!-- Prix unitaire HT (1,5x = 120px) -->
                <div style="width: 120px; padding: 4px;">
                </div>
                
                <!-- % Remise (1,5x = 90px) -->
                <div style="width: 90px; padding: 4px;">
                </div>
                
                <!-- TVA (1,5x = 105px) -->
                <div style="width: 105px; padding: 4px;">
                </div>
                
                <!-- Total HT ligne -->
                <div style="width: 80px; padding: 4px;" class="text-center">
                    <small class="total-ligne-display fw-bold text-success" style="font-size: 0.75rem; line-height: 23px;">0.00€</small>
                </div>
                
                <!-- Action -->
                <div style="width: 30px; padding: 4px;" class="text-center action-column">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-item-btn" title="Supprimer" style="padding: 2px 4px; font-size: 10px;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <!-- Champs Symfony cachés -->
            <div style="display: none;" class="symfony-fields"></div>
        </div>
        `);
        
        // Déplacer les champs Symfony dans la partie cachée et les adapter
        const $symFields = $newItem.find('input, select, textarea').clone();
        $newItemCompact.find('.symfony-fields').append($symFields);
        
        // Remplacer les champs visibles par les bons
        const designationField = $newItemCompact.find('.symfony-fields').find('[id$="_designation"]');
        const descriptionField = $newItemCompact.find('.symfony-fields').find('[id$="_description"]');
        const quantiteField = $newItemCompact.find('.symfony-fields').find('[id$="_quantite"]');
        const prixField = $newItemCompact.find('.symfony-fields').find('[id$="_prixUnitaireHt"]');
        const remiseField = $newItemCompact.find('.symfony-fields').find('[id$="_remisePercent"]');
        const tvaField = $newItemCompact.find('.symfony-fields').find('[id$="_tvaPercent"]');
        const produitField = $newItemCompact.find('.symfony-fields').find('[id$="_produit"]');
        
        // Intégrer les champs avec nouvelles largeurs 1,5x
        $newItemCompact.find('div[style*="width: 225px"]').append(designationField.addClass('form-control form-control-sm designation-input'));
        $newItemCompact.find('div.flex-fill').append(descriptionField.addClass('form-control form-control-sm description-input').attr('placeholder', 'Description détaillée...'));
        $newItemCompact.find('div[style*="width: 90px"]').first().append(quantiteField.addClass('form-control form-control-sm text-center quantity-input').val('1'));
        $newItemCompact.find('div[style*="width: 120px"]').eq(1).append(prixField.addClass('form-control form-control-sm text-end price-input').val('0.00').attr('placeholder', '0.00'));
        $newItemCompact.find('div[style*="width: 90px"]').eq(1).append(remiseField.addClass('form-control form-control-sm text-center remise-input').val('0.0').attr('max', '100').attr('min', '0').attr('step', '0.1'));
        $newItemCompact.find('div[style*="width: 105px"]').append(tvaField.addClass('form-select form-select-sm tva-select'));
        
        // Ajouter champ produit caché pour l'autocomplétion
        $newItemCompact.find('.symfony-fields').append(produitField.addClass('produit-id-input'));
        
        $collectionHolder.append($newItemCompact);
        
        // Masquer la colonne d'action si le devis n'est pas en brouillon
        {% if devis.statut != 'brouillon' %}
        $newItemCompact.find('.action-column').hide();
        {% endif %}
        
        // Initialiser l'autocomplétion pour cette ligne
        initAutocompleteForItem($newItemCompact);
        
        // Charger les taux de TVA
        loadTauxTva($newItemCompact);
        
        // Lier les événements de calcul
        bindCalculationEvents($newItemCompact);
        
        // Calculer les totaux
        calculateTotals();
        
        // Libérer le verrou
        setTimeout(function() {
            window.addingInProgress = false;
        }, 100);
    }

    // Attacher l'événement au bouton ligne libre
    $('.add-item-btn').off('click').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        addNewDevisItem();
    });
    
    // Attacher l'événement au bouton produit du catalogue
    $('.catalogue-product-btn').off('click').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        openCatalogueModal();
    });
    
    // Plus besoin de supprimer les boutons du parent car on n'hérite plus de new.html.twig

    // Fonction d'initialisation de l'autocomplétion pour une ligne
    function initAutocompleteForItem($item) {
        const $input = $item.find('.code-article-input');
        const $produitIdInput = $item.find('[id$="_produit"], .produit-id-input');
        const $designationInput = $item.find('[id$="_designation"], .designation-input');
        const $priceInput = $item.find('[id$="_prixUnitaireHt"], .price-input');
        const $tvaSelect = $item.find('[id$="_tvaPercent"], .tva-select');
        
        $input.on('input', function() {
            const term = $(this).val();
            if (term.length < 2) {
                return;
            }
            
            // Appel API pour recherche produits
            $.ajax({
                url: '/devis/api/produits',
                method: 'GET',
                data: { q: term },
                success: function(products) {
                    // Créer une liste déroulante des suggestions
                    const $existing = $item.find('.autocomplete-dropdown');
                    $existing.remove();
                    
                    if (products.length > 0) {
                        const $dropdown = $('<div class="autocomplete-dropdown list-group position-absolute" style="z-index: 1000; max-height: 200px; overflow-y: auto; width: 100%;"></div>');
                        
                        products.forEach(function(product) {
                            const $option = $('<a href="#" class="list-group-item list-group-item-action small"></a>');
                            $option.text(product.text);
                            $option.on('click', function(e) {
                                e.preventDefault();
                                
                                // Remplir les champs avec les données du produit
                                $input.val(product.reference);
                                $produitIdInput.val(product.id);
                                $designationInput.val(product.designation);
                                $priceInput.val(parseFloat(product.prix_vente_ht));
                                
                                // Sélectionner le taux de TVA correspondant
                                if (product.taux_tva) {
                                    $tvaSelect.val(product.taux_tva);
                                }
                                
                                $dropdown.remove();
                                
                                // Déclencher le calcul
                                calculateTotals();
                            });
                            $dropdown.append($option);
                        });
                        
                        $input.parent().append($dropdown);
                    }
                },
                error: function() {
                    console.error('Erreur lors de la recherche de produits');
                }
            });
        });
        
        // Fermer la dropdown quand on clique ailleurs
        $(document).on('click', function(e) {
            if (!$(e.target).closest($item).length) {
                $item.find('.autocomplete-dropdown').remove();
            }
        });
    }

    // Fonction de chargement des taux de TVA depuis admin
    function loadTauxTva($item) {
        const $select = $item.find('[id$="_tvaPercent"], .tva-select');
        
        $.ajax({
            url: '/devis/api/taux-tva',
            method: 'GET',
            success: function(tauxList) {
                $select.empty();
                $select.append('<option value="">Sélectionner TVA</option>');
                
                tauxList.forEach(function(taux) {
                    const $option = $('<option></option>');
                    // Format avec 2 décimales pour compatibilité
                    const tauxValue = parseFloat(taux.taux).toFixed(2);
                    $option.val(tauxValue);
                    // Affichage simplifié : juste le pourcentage
                    $option.text(parseFloat(taux.taux) + '%');
                    if (taux.parDefaut || taux.taux == 20) {
                        $option.prop('selected', true);
                    }
                    $select.append($option);
                });
            },
            error: function() {
                console.error('Erreur lors du chargement des taux de TVA depuis admin');
                // Fallback avec taux standard français
                $select.empty();
                $select.append('<option value="0.00">0%</option>');
                $select.append('<option value="5.50">5.5%</option>');
                $select.append('<option value="10.00">10%</option>');
                $select.append('<option value="20.00" selected>20%</option>');
            }
        });
    }

    // Fonction pour calculer les totaux
    function calculateTotals() {
        let totalHt = 0;
        let totalTva = 0;

        $('.devis-item').each(function() {
            // Utiliser les nouvelles classes CSS pour les champs
            const qte = parseFloat($(this).find('.quantity-input, [id$="_quantite"]').val()) || 0;
            const prixUnitaire = parseFloat($(this).find('.price-input, [id$="_prixUnitaireHt"]').val()) || 0;
            let remisePercent = parseFloat($(this).find('.remise-input, [id$="_remisePercent"]').val()) || 0;
            let tvaPercent = parseFloat($(this).find('.tva-select, [id$="_tvaPercent"]').val()) || 20;
            
            // Limiter les valeurs pour éviter l'erreur de dépassement de précision
            remisePercent = Math.min(Math.max(remisePercent, 0), 100); // Entre 0 et 100
            tvaPercent = Math.min(Math.max(tvaPercent, 0), 100); // Entre 0 et 100
            
            // Mettre à jour les champs avec format 1 décimale pour remise, 2 pour TVA
            $(this).find('.remise-input, [id$="_remisePercent"]').val(remisePercent.toFixed(1));
            $(this).find('.tva-select, [id$="_tvaPercent"]').val(tvaPercent.toFixed(2));

            // Calcul avec remise
            const sousTotal = qte * prixUnitaire;
            const montantRemise = sousTotal * remisePercent / 100;
            const totalLigneHt = sousTotal - montantRemise;
            const tvaLigne = totalLigneHt * tvaPercent / 100;

            // Mettre à jour les champs cachés
            $(this).find('.total-ligne-ht-input, [id$="_totalLigneHt"]').val(totalLigneHt.toFixed(2));
            
            // Mettre à jour l'affichage du montant net HT
            $(this).find('.total-display, .total-line-display').text(totalLigneHt.toFixed(2) + '€');

            totalHt += totalLigneHt;
            totalTva += tvaLigne;
        });

        const totalTtc = totalHt + totalTva;

        // Mettre à jour les totaux dans le récapitulatif
        $('.subtotal-ht, .total-ht').text(totalHt.toFixed(2) + '€');
        $('.total-tva').text(totalTva.toFixed(2) + '€');
        $('.total-ttc').text(totalTtc.toFixed(2) + '€');

        // Mettre à jour les champs cachés du formulaire principal
        $('input[name*="[totalHt]"]').val(totalHt.toFixed(2));
        $('input[name*="[totalTva]"]').val(totalTva.toFixed(2));
        $('input[name*="[totalTtc]"]').val(totalTtc.toFixed(2));
    }

    // Fonction pour lier les événements de calcul
    function bindCalculationEvents($container) {
        $container = $container || $(document);
        
        // Événements pour les anciens champs (lignes existantes)
        $container.find('[id$="_quantite"], [id$="_prixUnitaireHt"], [id$="_tvaPercent"], [id$="_remisePercent"]')
            .off('input change keyup')
            .on('input change keyup', function() {
                calculateTotals();
            });
            
        // Événements pour les nouveaux champs (nouvelles lignes)
        $container.find('.quantity-input, .price-input, .remise-input, .tva-select')
            .off('input change keyup')
            .on('input change keyup', function() {
                // Validation des limites pour les champs de pourcentage
                if ($(this).hasClass('remise-input')) {
                    let val = parseFloat($(this).val());
                    if (isNaN(val) || val < 0) $(this).val('0');
                    else if (val > 100) $(this).val('100');
                }
                calculateTotals();
            });
            
        // Gestion des boutons de suppression
        $container.find('.remove-item-btn').off('click').on('click', function() {
            const $item = $(this).closest('.devis-item');
            $item.remove();
            calculateTotals();
        });
        
        // Gestion des boutons catalogue
        $container.find('.catalogue-btn').off('click').on('click', function() {
            const $item = $(this).closest('.devis-item');
            openCatalogueModal($item);
        });
    }
    
    // Fonction pour ouvrir la modal du catalogue
    function openCatalogueModal() {
        // Créer une modal Bootstrap pour sélectionner un produit
        const modalHtml = `
        <div class="modal fade" id="catalogueModal" tabindex="-1" aria-labelledby="catalogueModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="catalogueModalLabel">
                            <i class="fas fa-book me-2"></i>Sélectionner un produit du catalogue
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="productSearch" placeholder="Rechercher un produit...">
                        </div>
                        <div id="productList" class="row">
                            <div class="col-12 text-center">
                                <i class="fas fa-spinner fa-spin"></i> Chargement des produits...
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    </div>
                </div>
            </div>
        </div>`;
        
        // Supprimer une éventuelle modal existante
        $('#catalogueModal').remove();
        
        // Ajouter la modal au DOM
        $('body').append(modalHtml);
        
        // Afficher la modal
        const modal = new bootstrap.Modal(document.getElementById('catalogueModal'));
        modal.show();
        
        // Charger les produits
        loadProductsInModal();
    }
    
    // Fonction pour charger les produits dans la modal
    function loadProductsInModal() {
        $.ajax({
            url: '/devis/api/produits',
            method: 'GET',
            data: { q: '' }, // Tous les produits
            success: function(products) {
                const $productList = $('#productList');
                $productList.empty();
                
                if (products.length === 0) {
                    $productList.html('<div class="col-12 text-center text-muted">Aucun produit disponible</div>');
                    return;
                }
                
                products.forEach(function(product) {
                    const productCard = `
                    <div class="col-md-6 mb-2">
                        <div class="card product-card" data-product-id="${product.id}" style="cursor: pointer;">
                            <div class="card-body p-2">
                                <h6 class="card-title mb-1">${product.designation}</h6>
                                <small class="text-muted d-block mb-1">Code: ${product.reference}</small>
                                <small class="text-success fw-bold">${product.prix_vente_ht}€ HT</small>
                                ${product.taux_tva ? '<small class="text-info ms-2">TVA: ' + product.taux_tva + '%</small>' : ''}
                            </div>
                        </div>
                    </div>`;
                    $productList.append(productCard);
                });
                
                // Ajouter les événements de clic sur les produits
                $('.product-card').on('click', function() {
                    const productId = $(this).data('product-id');
                    const product = products.find(p => p.id == productId);
                    if (product) {
                        addNewDevisItemFromProduct(product);
                        bootstrap.Modal.getInstance(document.getElementById('catalogueModal')).hide();
                    }
                });
            },
            error: function() {
                $('#productList').html('<div class="col-12 text-center text-danger">Erreur lors du chargement des produits</div>');
            }
        });
    }
    
    // Fonction pour ajouter une ligne de devis à partir d'un produit du catalogue
    function addNewDevisItemFromProduct(product) {
        // Créer d'abord une ligne vide
        addNewDevisItem();
        
        // Ensuite remplir avec les données du produit
        setTimeout(function() {
            const $lastItem = $('.devis-item').last();
            $lastItem.find('.code-article-input').val(product.reference);
            $lastItem.find('.designation-input').val(product.designation);
            $lastItem.find('.description-input').val(product.description || '');
            $lastItem.find('.price-input').val(parseFloat(product.prix_vente_ht));
            $lastItem.find('.tva-select').val(product.taux_tva ? parseFloat(product.taux_tva).toFixed(2) : '20.00');
            
            // Recalculer les totaux
            calculateTotals();
        }, 100);
    }

    // Charger les taux TVA pour toutes les lignes existantes
    $('.devis-item').each(function() {
        const $select = $(this).find('.tva-select');
        const currentValue = $select.data('current-value');
        loadTauxTva($(this));
        // Restaurer la valeur après chargement
        if (currentValue) {
            setTimeout(() => {
                $select.val(parseFloat(currentValue).toFixed(2));
            }, 200);
        }
    });
    
    // Lier les événements pour les lignes existantes
    bindCalculationEvents();
    
    // Calculer les totaux au chargement
    calculateTotals();

    {% endif %}
    
    // Gestion du panneau récapitulatif flottant - avec délégation d'événement
    $(document).on('click', '#summary-toggle', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Bouton summary cliqué'); // Debug
        
        const $summary = $('#floating-summary');
        const $content = $('#summary-content');
        
        $summary.toggleClass('expanded');
        
        if ($summary.hasClass('expanded')) {
            $content.slideDown(200);
        } else {
            $content.slideUp(200);
        }
    });
    
    // Fonction pour mettre à jour le récapitulatif flottant
    function updateFloatingSummary() {
        const totalHt = $('.total-ht').first().text();
        const totalTva = $('.total-tva').first().text();
        const totalTtc = $('.total-ttc').first().text();
        
        // Mettre à jour l'affichage dans le toggle
        $('.summary-total-display').text(totalTtc + ' TTC');
    }
    
    // Mettre à jour le récapitulatif après chaque calcul
    const originalCalculateTotals = calculateTotals;
    calculateTotals = function() {
        originalCalculateTotals();
        setTimeout(updateFloatingSummary, 50);
    };
});
</script>
{% endblock %}
{% endblock %}