# üìã SP√âCIFICATIONS D√âTAILL√âES - Workflow Commercial Complet
## TechnoProd ERP - Extension Commande/Facture/Avoir

**Version :** 1.0  
**Date :** 22 Juillet 2025  
**Auteur :** √âquipe TechnoProd  

---

## üéØ 1. VISION ET OBJECTIFS

### **1.1 Vision G√©n√©rale**
Transformer TechnoProd d'un syst√®me de gestion de devis en **ERP commercial complet** avec workflow bout-en-bout : Prospect ‚Üí Devis ‚Üí Commande ‚Üí Facture ‚Üí Avoir.

### **1.2 Objectifs Fonctionnels**
- ‚úÖ **Continuit√© workflow** : Liaison automatique entre tous les documents
- ‚úÖ **Gestion des avoirs** : Retours, ristournes, corrections
- ‚úÖ **Suivi paiements** : Encaissements et remboursements  
- ‚úÖ **Pilotage commercial** : Dashboard temps r√©el et KPI
- ‚úÖ **Conformit√© comptable** : Respect des r√®gles fran√ßaises

### **1.3 Objectifs Techniques**
- ‚úÖ **Architecture extensible** : Pr√™t pour modules futurs
- ‚úÖ **Performance optimis√©e** : Requ√™tes et indexation
- ‚úÖ **S√©curit√© renforc√©e** : Validation des transitions d'√©tat
- ‚úÖ **Tests automatis√©s** : Couverture compl√®te des workflows

---

## üèóÔ∏è 2. ARCHITECTURE DES DONN√âES

### **2.1 Entit√©s Existantes (Conserv√©es)**
```php
// EXISTANT - AUCUNE MODIFICATION
- Prospect (clients/prospects unifi√©s)
- Devis (avec signature √©lectronique)  
- DevisItem (lignes de devis)
- Produit (catalogue)
- User (utilisateurs/commerciaux)
- Secteur/Zone (territoires commerciaux)
- Contact/Adresse (Facturation/Livraison)
```

### **2.2 Nouvelles Entit√©s √† Cr√©er**

#### **2.2.1 Entit√© COMMANDE**
```php
#[ORM\Entity]
class Commande
{
    #[ORM\Id, ORM\GeneratedValue]
    private ?int $id = null;

    #[ORM\Column(length: 20, unique: true)]
    private ?string $numeroCommande = null; // CMD-2025-0001

    // RELATIONS
    #[ORM\ManyToOne(targetEntity: Devis::class)]
    #[ORM\JoinColumn(nullable: false)]
    private Devis $devisOrigine;

    #[ORM\ManyToOne(targetEntity: Prospect::class)]
    #[ORM\JoinColumn(nullable: false)]  
    private Prospect $prospect;

    #[ORM\ManyToOne(targetEntity: User::class)]
    private User $commercial;

    #[ORM\OneToMany(mappedBy: 'commande', targetEntity: CommandeItem::class, cascade: ['persist', 'remove'])]
    private Collection $commandeItems;

    #[ORM\OneToMany(mappedBy: 'commande', targetEntity: Facture::class)]
    private Collection $factures;

    // WORKFLOW ET DATES
    #[ORM\Column(length: 20)]
    private string $statut = 'confirmee';

    #[ORM\Column(type: Types::DATETIME_MUTABLE)]
    private DateTimeInterface $dateCommande;

    #[ORM\Column(type: Types::DATE_MUTABLE, nullable: true)]
    private ?DateTimeInterface $dateProductionPrevue = null;

    #[ORM\Column(type: Types::DATE_MUTABLE, nullable: true)]
    private ?DateTimeInterface $dateExpedition = null;

    #[ORM\Column(type: Types::DATE_MUTABLE, nullable: true)]  
    private ?DateTimeInterface $dateLivraisonPrevue = null;

    #[ORM\Column(type: Types::DATE_MUTABLE, nullable: true)]
    private ?DateTimeInterface $dateLivraisonReelle = null;

    // MONTANTS (reprise du devis)
    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $totalHt = '0.00';

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $totalTva = '0.00';

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $totalTtc = '0.00';

    // INFORMATIONS LOGISTIQUES
    #[ORM\Column(type: Types::TEXT, nullable: true)]
    private ?string $instructionsLivraison = null;

    #[ORM\Column(length: 100, nullable: true)]
    private ?string $transporteur = null;

    #[ORM\Column(length: 50, nullable: true)]
    private ?string $numeroSuivi = null;

    // AUDIT
    #[ORM\Column(type: Types::DATETIME_MUTABLE)]
    private DateTimeInterface $createdAt;

    #[ORM\Column(type: Types::DATETIME_MUTABLE)]  
    private DateTimeInterface $updatedAt;
}
```

#### **2.2.2 Entit√© COMMANDE_ITEM**
```php
#[ORM\Entity]
class CommandeItem
{
    #[ORM\Id, ORM\GeneratedValue]
    private ?int $id = null;

    #[ORM\ManyToOne(targetEntity: Commande::class, inversedBy: 'commandeItems')]
    private Commande $commande;

    #[ORM\ManyToOne(targetEntity: DevisItem::class)]
    private DevisItem $devisItemOrigine;

    #[ORM\ManyToOne(targetEntity: Produit::class)]
    private ?Produit $produit = null;

    // DONN√âES PRODUIT (fig√©es √† la commande)
    #[ORM\Column(length: 255)]
    private string $designation;

    #[ORM\Column(type: Types::TEXT, nullable: true)]
    private ?string $description = null;

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 3)]
    private string $quantite;

    #[ORM\Column(length: 10)]
    private string $unite = 'U';

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $prixUnitaireHt;

    #[ORM\Column(type: Types::DECIMAL, precision: 5, scale: 2)]
    private string $tvaPercent;

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $totalLigneHt;

    // STATUT PRODUCTION PAR LIGNE
    #[ORM\Column(length: 20)]
    private string $statutProduction = 'en_attente';

    #[ORM\Column(type: Types::DATE_MUTABLE, nullable: true)]
    private ?DateTimeInterface $dateProductionPrevue = null;

    #[ORM\Column(type: Types::DATE_MUTABLE, nullable: true)]
    private ?DateTimeInterface $dateProductionReelle = null;

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 3, nullable: true)]
    private ?string $quantiteLivree = null;
}
```

#### **2.2.3 Entit√© FACTURE**
```php
#[ORM\Entity]  
class Facture
{
    #[ORM\Id, ORM\GeneratedValue]
    private ?int $id = null;

    #[ORM\Column(length: 20, unique: true)]
    private ?string $numeroFacture = null; // FACT-2025-0001

    // RELATIONS ORIGINES
    #[ORM\ManyToOne(targetEntity: Devis::class)]
    private ?Devis $devisOrigine = null;

    #[ORM\ManyToOne(targetEntity: Commande::class, inversedBy: 'factures')]
    private ?Commande $commandeOrigine = null;

    // RELATIONS STANDARD  
    #[ORM\ManyToOne(targetEntity: Prospect::class)]
    #[ORM\JoinColumn(nullable: false)]
    private Prospect $prospect;

    #[ORM\ManyToOne(targetEntity: User::class)]
    private User $commercial;

    #[ORM\OneToMany(mappedBy: 'facture', targetEntity: FactureItem::class, cascade: ['persist', 'remove'])]
    private Collection $factureItems;

    #[ORM\OneToMany(mappedBy: 'facture', targetEntity: Paiement::class)]
    private Collection $paiements;

    #[ORM\OneToMany(mappedBy: 'factureOriginale', targetEntity: Avoir::class)]
    private Collection $avoirs;

    // WORKFLOW ET DATES
    #[ORM\Column(length: 20)]
    private string $statut = 'brouillon';

    #[ORM\Column(type: Types::DATE_MUTABLE)]
    private DateTimeInterface $dateFacture;

    #[ORM\Column(type: Types::DATE_MUTABLE)]
    private DateTimeInterface $dateEcheance;

    #[ORM\Column(type: Types::DATE_MUTABLE, nullable: true)]
    private ?DateTimeInterface $dateEnvoi = null;

    #[ORM\Column(type: Types::DATE_MUTABLE, nullable: true)]
    private ?DateTimeInterface $datePaiementComplet = null;

    // MONTANTS
    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $totalHt = '0.00';

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $totalTva = '0.00';

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $totalTtc = '0.00';

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $totalPaye = '0.00';

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $totalAvoir = '0.00';

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $soldeRestant = '0.00';

    // INFORMATIONS PAIEMENT
    #[ORM\Column(type: Types::TEXT, nullable: true)]
    private ?string $conditionsPaiement = null;

    #[ORM\Column(type: Types::TEXT, nullable: true)]
    private ?string $mentionsLegales = null;

    // AUDIT
    #[ORM\Column(type: Types::DATETIME_MUTABLE)]
    private DateTimeInterface $createdAt;

    #[ORM\Column(type: Types::DATETIME_MUTABLE)]
    private DateTimeInterface $updatedAt;
}
```

#### **2.2.4 Entit√© FACTURE_ITEM**
```php
#[ORM\Entity]
class FactureItem  
{
    #[ORM\Id, ORM\GeneratedValue]
    private ?int $id = null;

    #[ORM\ManyToOne(targetEntity: Facture::class, inversedBy: 'factureItems')]
    private Facture $facture;

    #[ORM\ManyToOne(targetEntity: CommandeItem::class)]
    private ?CommandeItem $commandeItemOrigine = null;

    #[ORM\ManyToOne(targetEntity: Produit::class)]
    private ?Produit $produit = null;

    // DONN√âES FIG√âES √Ä LA FACTURE
    #[ORM\Column(length: 255)]
    private string $designation;

    #[ORM\Column(type: Types::TEXT, nullable: true)]
    private ?string $description = null;

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 3)]
    private string $quantite;

    #[ORM\Column(length: 10)]
    private string $unite = 'U';

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $prixUnitaireHt;

    #[ORM\Column(type: Types::DECIMAL, precision: 5, scale: 2)]
    private string $tvaPercent;

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $totalLigneHt;

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $totalLigneTva;

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $totalLigneTtc;

    // SUIVI AVOIRS
    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 3)]
    private string $quantiteAvoir = '0.000';

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $montantAvoir = '0.00';
}
```

#### **2.2.5 Entit√© AVOIR (Entit√© Cl√©)**
```php
#[ORM\Entity]
class Avoir
{
    #[ORM\Id, ORM\GeneratedValue]
    private ?int $id = null;

    #[ORM\Column(length: 20, unique: true)]
    private ?string $numeroAvoir = null; // AVOIR-2025-0001

    // RELATIONS
    #[ORM\ManyToOne(targetEntity: Facture::class, inversedBy: 'avoirs')]
    #[ORM\JoinColumn(nullable: false)]
    private Facture $factureOriginale;

    #[ORM\ManyToOne(targetEntity: Prospect::class)]
    #[ORM\JoinColumn(nullable: false)]
    private Prospect $prospect;

    #[ORM\ManyToOne(targetEntity: User::class)]
    private User $commercial;

    #[ORM\OneToMany(mappedBy: 'avoir', targetEntity: AvoirItem::class, cascade: ['persist', 'remove'])]
    private Collection $avoirItems;

    #[ORM\OneToMany(mappedBy: 'avoir', targetEntity: Paiement::class)]
    private Collection $remboursements;

    // MOTIF ET WORKFLOW
    #[ORM\Column(length: 30)]
    private string $motif; // 'retour_marchandise', 'ristourne_commerciale', 'erreur_facturation', 'geste_commercial'

    #[ORM\Column(length: 20)]
    private string $statut = 'brouillon'; // 'brouillon', 'valide', 'rembourse', 'annule'

    #[ORM\Column(type: Types::TEXT, nullable: true)]
    private ?string $motifDetaille = null;

    // DATES
    #[ORM\Column(type: Types::DATE_MUTABLE)]
    private DateTimeInterface $dateAvoir;

    #[ORM\Column(type: Types::DATE_MUTABLE, nullable: true)]
    private ?DateTimeInterface $dateValidation = null;

    #[ORM\Column(type: Types::DATE_MUTABLE, nullable: true)]
    private ?DateTimeInterface $dateRemboursement = null;

    // MONTANTS
    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $totalHt = '0.00';

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $totalTva = '0.00';

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $totalTtc = '0.00';

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $montantRembourse = '0.00';

    // VALIDATION
    #[ORM\ManyToOne(targetEntity: User::class)]
    private ?User $validateurAvoir = null;

    #[ORM\Column(type: Types::TEXT, nullable: true)]
    private ?string $commentaireValidation = null;

    // AUDIT
    #[ORM\Column(type: Types::DATETIME_MUTABLE)]
    private DateTimeInterface $createdAt;

    #[ORM\Column(type: Types::DATETIME_MUTABLE)]
    private DateTimeInterface $updatedAt;
}
```

#### **2.2.6 Entit√© AVOIR_ITEM**
```php  
#[ORM\Entity]
class AvoirItem
{
    #[ORM\Id, ORM\GeneratedValue]
    private ?int $id = null;

    #[ORM\ManyToOne(targetEntity: Avoir::class, inversedBy: 'avoirItems')]
    private Avoir $avoir;

    #[ORM\ManyToOne(targetEntity: FactureItem::class)]
    #[ORM\JoinColumn(nullable: false)]
    private FactureItem $factureItemOriginale;

    // QUANTIT√â ET MONTANT √Ä CR√âDITER
    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 3)]
    private string $quantiteAvoir;

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $prixUnitaireHt;

    #[ORM\Column(type: Types::DECIMAL, precision: 5, scale: 2)]
    private string $tvaPercent;

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $totalLigneHt;

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $totalLigneTva;

    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $totalLigneTtc;

    // MOTIF LIGNE
    #[ORM\Column(type: Types::TEXT, nullable: true)]
    private ?string $motifLigne = null;
}
```

#### **2.2.7 Entit√© PAIEMENT (Support)**
```php
#[ORM\Entity]
class Paiement
{
    #[ORM\Id, ORM\GeneratedValue]
    private ?int $id = null;

    #[ORM\Column(length: 20, unique: true)]
    private ?string $numeroPaiement = null; // PAIE-2025-0001

    // RELATIONS (EXCLUSIVES)
    #[ORM\ManyToOne(targetEntity: Facture::class, inversedBy: 'paiements')]
    private ?Facture $facture = null;

    #[ORM\ManyToOne(targetEntity: Avoir::class, inversedBy: 'remboursements')]
    private ?Avoir $avoir = null;

    // TYPE ET MODE
    #[ORM\Column(length: 20)]
    private string $type; // 'encaissement', 'remboursement'

    #[ORM\Column(length: 20)]
    private string $mode; // 'cheque', 'virement', 'carte_bancaire', 'especes', 'prelevement'

    // MONTANT ET DATES
    #[ORM\Column(type: Types::DECIMAL, precision: 10, scale: 2)]
    private string $montant;

    #[ORM\Column(type: Types::DATE_MUTABLE)]
    private DateTimeInterface $datePaiement;

    #[ORM\Column(type: Types::DATE_MUTABLE, nullable: true)]
    private ?DateTimeInterface $dateEncaissement = null;

    // R√âF√âRENCES
    #[ORM\Column(length: 100, nullable: true)]
    private ?string $referenceBancaire = null;

    #[ORM\Column(length: 100, nullable: true)]
    private ?string $numeroTransaction = null;

    // STATUT
    #[ORM\Column(length: 20)]
    private string $statut = 'en_attente'; // 'en_attente', 'encaisse', 'rejete', 'annule'

    #[ORM\Column(type: Types::TEXT, nullable: true)]
    private ?string $commentaire = null;

    // AUDIT
    #[ORM\Column(type: Types::DATETIME_MUTABLE)]
    private DateTimeInterface $createdAt;

    #[ORM\Column(type: Types::DATETIME_MUTABLE)]
    private DateTimeInterface $updatedAt;
}
```

---

## üîÑ 3. WORKFLOWS D√âTAILL√âS

### **3.1 Workflow DEVIS (Existant - Inchang√©)**
```
STATES: brouillon ‚Üí envoye ‚Üí {accepte|refuse|expire}
TRANSITIONS:
- brouillon ‚Üí envoye (envoi email client)
- envoye ‚Üí accepte (signature √©lectronique)  
- envoye ‚Üí refuse (refus client)
- envoye ‚Üí expire (d√©lai validit√© d√©pass√©)
- accepte ‚Üí commande_generee (conversion automatique)
```

### **3.2 Workflow COMMANDE (Nouveau)**
```
STATES: confirmee ‚Üí preparation ‚Üí production ‚Üí expediee ‚Üí livree ‚Üí facturee
BRANCH STATES: annulee
RETOUR POSSIBLE: production ‚Üí preparation (modifications)

TRANSITIONS:
- confirmee ‚Üí preparation (mise en production)
- preparation ‚Üí production (d√©but fabrication/service)
- production ‚Üí expediee (envoi/installation)
- expediee ‚Üí livree (r√©ception client)
- livree ‚Üí facturee (g√©n√©ration facture)
- [ANY] ‚Üí annulee (annulation client/interne)

AUTOMATISATIONS:
- Auto-transition si tous CommandeItems au m√™me statut
- Email notifications sur changements d'√©tat
- Mise √† jour dates pr√©visionnelles
```

### **3.3 Workflow FACTURE (Nouveau)**
```
STATES: brouillon ‚Üí envoyee ‚Üí {payee|en_relance|en_litige} ‚Üí archivee
BRANCH STATES: annulee, avoir_emis

TRANSITIONS:
- brouillon ‚Üí envoyee (envoi client)
- envoyee ‚Üí payee (paiement complet)
- envoyee ‚Üí en_relance (√©ch√©ance d√©pass√©e)  
- en_relance ‚Üí en_litige (relances inefficaces)
- payee ‚Üí archivee (cl√¥ture administrative)
- [envoyee|payee] ‚Üí avoir_emis (cr√©ation avoir)

AUTOMATISATIONS:
- Passage auto en_relance J+30 apr√®s √©ch√©ance
- Calcul automatique soldes restants
- G√©n√©ration PDF facture
```

### **3.4 Workflow AVOIR (Nouveau - Critique)**
```
STATES: brouillon ‚Üí valide ‚Üí {rembourse|utilise} ‚Üí cloture
BRANCH STATES: annule, refuse

TRANSITIONS:
- brouillon ‚Üí valide (validation manager)
- valide ‚Üí rembourse (remboursement effectu√©)
- valide ‚Üí utilise (compensation sur nouvelle facture)
- valide ‚Üí refuse (rejet demande client)
- [ANY] ‚Üí annule (annulation administrative)
- [rembourse|utilise] ‚Üí cloture (finalisation)

VALIDATIONS:
- Montant avoir ‚â§ montant facture restant
- Motif obligatoire avec d√©tails
- Approbation manag√©riale requise
- Impact automatique sur soldes facture
```

---

## üéÆ 4. R√àGLES M√âTIER CRITIQUES

### **4.1 R√®gles de Conversion**

#### **Devis ‚Üí Commande**
```php
D√âCLENCHEURS:
- Devis.statut = 'accepte' 
- Signature √©lectronique pr√©sente
- Acompte pay√© (si requis)

PROCESS:
1. Cr√©ation Commande avec num√©ro auto
2. Copie de tous les DevisItems vers CommandeItems
3. Conservation r√©f√©rences originales
4. Statut initial = 'confirmee'
5. Dates pr√©visionnelles calcul√©es
6. Devis.statut = 'commande_generee'

VALIDATION:
- Pas de modification des prix lors copie
- Quantit√©s > 0 obligatoires
- Prospect actif requis
```

#### **Commande ‚Üí Facture**
```php
D√âCLENCHEURS:
- Commande.statut = 'livree'
- OU Facturation partielle autoris√©e
- Action manuelle utilisateur

PROCESS:
1. S√©lection CommandeItems √† facturer
2. Cr√©ation Facture avec num√©ro auto
3. G√©n√©ration FactureItems correspondants
4. Calcul montants et TVA
5. Statut initial = 'brouillon'
6. Date √©ch√©ance = date facture + d√©lai paiement

VALIDATION:  
- CommandeItems.statutProduction = 'livre' 
- Quantit√© √† facturer ‚â§ quantit√© command√©e
- Pas de double facturation
```

#### **Facture ‚Üí Avoir**
```php
D√âCLENCHEURS:
- Facture.statut IN ('envoyee', 'payee')
- Demande client ou d√©cision interne
- Action manuelle avec validation

PROCESS:
1. S√©lection FactureItems √† cr√©diter
2. Saisie motif et quantit√©s
3. Cr√©ation Avoir avec num√©ro auto
4. Statut initial = 'brouillon'
5. Validation manag√©riale obligatoire

VALIDATION:
- Quantit√© avoir ‚â§ quantit√© factur√©e restante
- Motif dans liste pr√©d√©finie
- Approbation utilisateur ROLE_MANAGER
- Impact imm√©diat sur Facture.soldeRestant
```

### **4.2 R√®gles de Calcul**

#### **Montants et Totaux**
```php
// FORMULES STANDARD
totalLigneHt = quantite √ó prixUnitaireHt
totalLigneTva = totalLigneHt √ó (tvaPercent / 100)  
totalLigneTtc = totalLigneHt + totalLigneTva

// TOTAUX DOCUMENT
totalHt = SUM(items.totalLigneHt)
totalTva = SUM(items.totalLigneTva)  
totalTtc = SUM(items.totalLigneTtc)

// SOLDES FACTURE
soldeRestant = totalTtc - totalPaye - totalAvoir
```

#### **Impact Avoirs sur Factures**
```php
// APR√àS VALIDATION AVOIR
Facture.totalAvoir += Avoir.totalTtc
Facture.soldeRestant = Facture.totalTtc - Facture.totalPaye - Facture.totalAvoir

// STATUT AUTO SI SOLD√â
if (Facture.soldeRestant <= 0.01) {
    Facture.statut = 'payee'
    Facture.datePaiementComplet = now()
}
```

### **4.3 R√®gles de S√©curit√©**

#### **Contr√¥les de Coh√©rence**
```php
INTERDICTIONS:
- Supprimer document avec suite workflow
- Modifier montants si statut > 'brouillon'  
- Avoir > montant facture restant d√ª
- Paiement > solde restant facture

VALIDATIONS:
- Dates coh√©rentes (commande < livraison < facture)
- Quantit√©s positives sur toutes lignes
- TVA dans fourchettes l√©gales (0-25%)
- Utilisateur avec droits suffisants
```

#### **Droits et Approbations**
```php
ROLES REQUIS:
- ROLE_USER: Devis, consultation
- ROLE_COMMERCIAL: Commandes, factures brouillon  
- ROLE_MANAGER: Validation avoirs, annulations
- ROLE_ADMIN: Configuration, exports

APPROBATIONS:
- Avoir > 500‚Ç¨: ROLE_MANAGER obligatoire
- Annulation commande: ROLE_MANAGER
- Modification facture envoy√©e: ROLE_ADMIN
```

---

## üé® 5. INTERFACES UTILISATEUR

### **5.1 Dashboard Commercial (Extension)**
```php
WIDGETS EXISTANTS: (conserv√©s)
- Statistiques devis par statut
- Pipeline commercial mensuel
- Top prospects et secteurs

NOUVEAUX WIDGETS:
- Commandes en cours par statut
- Factures impay√©es avec alertes  
- Avoirs du mois (montant et causes)
- CA facturation vs encaissements
- D√©lais moyens par √©tape workflow
```

### **5.2 Nouvelles Pages √† Cr√©er**

#### **Commandes**
```php
/commande                    # Index avec filtres statuts
/commande/new               # Cr√©ation (depuis devis accept√©)
/commande/{id}              # Vue d√©taill√©e avec suivi
/commande/{id}/edit         # Modification (si statut permet)
/commande/{id}/production   # Gestion production par ligne
/commande/{id}/livraison    # Saisie infos livraison
/commande/{id}/facture/new  # G√©n√©ration facture
```

#### **Factures**  
```php
/facture                    # Index avec filtres et alertes
/facture/new               # Cr√©ation (depuis commande/directe)
/facture/{id}              # Vue d√©taill√©e avec paiements
/facture/{id}/edit         # Modification (si brouillon)
/facture/{id}/pdf          # G√©n√©ration PDF
/facture/{id}/envoyer      # Envoi email client
/facture/{id}/paiement/new # Saisie paiement
/facture/{id}/avoir/new    # Cr√©ation avoir
```

#### **Avoirs**
```php  
/avoir                     # Index avec validations en attente
/avoir/new                 # Cr√©ation (depuis facture)
/avoir/{id}                # Vue d√©taill√©e
/avoir/{id}/edit          # Modification (si brouillon)
/avoir/{id}/valider       # Validation manag√©riale
/avoir/{id}/pdf           # G√©n√©ration PDF
/avoir/{id}/remboursement # Saisie remboursement
```

### **5.3 Templates Design**

#### **Coh√©rence Visuelle**
- **M√™me charte** que devis existants
- **Couleurs par statut** : vert/orange/rouge
- **Icons FontAwesome** : fas fa-shopping-cart (commande), fas fa-file-invoice (facture), fas fa-undo (avoir)
- **Bootstrap 5** avec composants modernes

#### **√âl√©ments Sp√©cifiques**
```php  
STATUT BADGES:
- Commande: badge-primary (confirm√©e), badge-warning (production), badge-success (livr√©e)
- Facture: badge-secondary (brouillon), badge-info (envoy√©e), badge-success (pay√©e)
- Avoir: badge-warning (brouillon), badge-success (valid√©), badge-danger (refus√©)

TIMELINE WORKFLOW:
- Visualisation √©tapes avec points de passage
- Dates r√©elles vs pr√©visionnelles  
- Indicateurs de retard en rouge

TOTAUX ET SOLDES:
- Mise en √©vidence soldes restants
- Alertes visuelles impay√©s
- Graphiques simples CA/encaissements
```

---

## ‚öôÔ∏è 6. D√âVELOPPEMENT TECHNIQUE

### **6.1 Structure des Contr√¥leurs**
```php
// NOUVEAUX CONTR√îLEURS
CommandeController::class
‚îú‚îÄ‚îÄ index()           # Liste avec filtres
‚îú‚îÄ‚îÄ show($id)         # Vue d√©taill√©e  
‚îú‚îÄ‚îÄ new()             # Cr√©ation depuis devis
‚îú‚îÄ‚îÄ edit($id)         # Modification
‚îú‚îÄ‚îÄ production($id)   # Gestion production
‚îú‚îÄ‚îÄ livraison($id)    # Saisie livraison
‚îî‚îÄ‚îÄ genererFacture($id) # Cr√©ation facture

FactureController::class  
‚îú‚îÄ‚îÄ index()           # Liste avec alertes impay√©s
‚îú‚îÄ‚îÄ show($id)         # Vue avec paiements/avoirs
‚îú‚îÄ‚îÄ new()             # Cr√©ation
‚îú‚îÄ‚îÄ edit($id)         # Modification
‚îú‚îÄ‚îÄ pdf($id)          # G√©n√©ration PDF
‚îú‚îÄ‚îÄ envoyer($id)      # Envoi email
‚îú‚îÄ‚îÄ paiement($id)     # Saisie paiement
‚îî‚îÄ‚îÄ genererAvoir($id) # Cr√©ation avoir

AvoirController::class
‚îú‚îÄ‚îÄ index()           # Liste avec validations
‚îú‚îÄ‚îÄ show($id)         # Vue d√©taill√©e
‚îú‚îÄ‚îÄ new()             # Cr√©ation depuis facture  
‚îú‚îÄ‚îÄ edit($id)         # Modification
‚îú‚îÄ‚îÄ valider($id)      # Approbation manager
‚îú‚îÄ‚îÄ pdf($id)          # G√©n√©ration PDF
‚îî‚îÄ‚îÄ rembourser($id)   # Saisie remboursement
```

### **6.2 Services M√©tier**
```php
// NOUVEAUX SERVICES
CommandeService::class
‚îú‚îÄ‚îÄ creerDepuisDevis(Devis $devis): Commande
‚îú‚îÄ‚îÄ changerStatut(Commande $commande, string $statut): void
‚îú‚îÄ‚îÄ calculerDelaisPrevisionnels(Commande $commande): array
‚îî‚îÄ‚îÄ verifierCoherenceStatuts(Commande $commande): bool

FactureService::class
‚îú‚îÄ‚îÄ creerDepuisCommande(Commande $commande, array $items): Facture  
‚îú‚îÄ‚îÄ calculerSoldeRestant(Facture $facture): string
‚îú‚îÄ‚îÄ genererNumeroFacture(): string
‚îú‚îÄ‚îÄ marquerPayee(Facture $facture): void
‚îî‚îÄ‚îÄ verifierEcheance(Facture $facture): bool

AvoirService::class
‚îú‚îÄ‚îÄ creerDepuisFacture(Facture $facture, array $items, string $motif): Avoir
‚îú‚îÄ‚îÄ valider(Avoir $avoir, User $validateur): void  
‚îú‚îÄ‚îÄ impacterFacture(Avoir $avoir): void
‚îú‚îÄ‚îÄ calculerMontants(Avoir $avoir): void
‚îî‚îÄ‚îÄ verifierQuantitesDisponibles(Facture $facture, array $items): bool

WorkflowService::class (extension)
‚îú‚îÄ‚îÄ executerTransition(object $entity, string $from, string $to): void
‚îú‚îÄ‚îÄ getTransitionsPossibles(object $entity): array  
‚îú‚îÄ‚îÄ verifierDroitsTransition(object $entity, string $transition, User $user): bool
‚îî‚îÄ‚îÄ notifierChangementStatut(object $entity, string $ancienStatut): void
```

### **6.3 Formulaires Symfony**
```php
// NOUVEAUX FORMULAIRES
CommandeType::class
‚îú‚îÄ‚îÄ CommandeItemType (embedded collection)
‚îú‚îÄ‚îÄ Champs dates pr√©visionnelles  
‚îú‚îÄ‚îÄ Instructions livraison
‚îî‚îÄ‚îÄ S√©lection transporteur

FactureType::class
‚îú‚îÄ‚îÄ FactureItemType (embedded collection)
‚îú‚îÄ‚îÄ Conditions paiement
‚îú‚îÄ‚îÄ Date √©ch√©ance  
‚îî‚îÄ‚îÄ Mentions l√©gales

AvoirType::class
‚îú‚îÄ‚îÄ AvoirItemType (embedded collection)
‚îú‚îÄ‚îÄ S√©lection motif (choix)
‚îú‚îÄ‚îÄ Saisie motif d√©taill√©
‚îî‚îÄ‚îÄ Quantit√©s √† cr√©diter

PaiementType::class  
‚îú‚îÄ‚îÄ Montant avec validation
‚îú‚îÄ‚îÄ Mode paiement (choix)
‚îú‚îÄ‚îÄ R√©f√©rences bancaires
‚îî‚îÄ‚îÄ Date encaissement
```

### **6.4 Migrations Base de Donn√©es**
```php
// ORDRE D'EX√âCUTION DES MIGRATIONS
1. Migration001_CreateCommande.php
2. Migration002_CreateCommandeItem.php  
3. Migration003_CreateFacture.php
4. Migration004_CreateFactureItem.php
5. Migration005_CreateAvoir.php
6. Migration006_CreateAvoirItem.php
7. Migration007_CreatePaiement.php
8. Migration008_AddForeignKeys.php
9. Migration009_CreateIndexes.php
10. Migration010_UpdateExistingData.php

// CONTRAINTES IMPORTANTES
- Cl√©s √©trang√®res avec CASCADE appropri√©s
- Index sur num√©ros documents (uniques)
- Index sur statuts et dates (performances)
- Contraintes CHECK sur montants positifs
```

### **6.5 Tests Automatis√©s**
```php
// COUVERTURE TESTS REQUISE
tests/Entity/           # Tests unitaires entit√©s
‚îú‚îÄ‚îÄ CommandeTest.php    # Relations et calculs
‚îú‚îÄ‚îÄ FactureTest.php     # Soldes et statuts
‚îú‚îÄ‚îÄ AvoirTest.php       # Validations m√©tier
‚îî‚îÄ‚îÄ PaiementTest.php    # Contraintes

tests/Service/          # Tests services m√©tier
‚îú‚îÄ‚îÄ CommandeServiceTest.php
‚îú‚îÄ‚îÄ FactureServiceTest.php  
‚îú‚îÄ‚îÄ AvoirServiceTest.php
‚îî‚îÄ‚îÄ WorkflowServiceTest.php

tests/Controller/       # Tests fonctionnels
‚îú‚îÄ‚îÄ CommandeControllerTest.php
‚îú‚îÄ‚îÄ FactureControllerTest.php
‚îî‚îÄ‚îÄ AvoirControllerTest.php

tests/Integration/      # Tests d'int√©gration  
‚îú‚îÄ‚îÄ WorkflowCompletTest.php  # Devis ‚Üí Commande ‚Üí Facture ‚Üí Avoir
‚îú‚îÄ‚îÄ CalculMontantsTest.php   # Coh√©rence montants/soldes
‚îî‚îÄ‚îÄ SecurityTest.php         # Contr√¥les droits acc√®s
```

---

## üìä 7. DONN√âES ET FIXTURES

### **7.1 Fixtures de D√©veloppement**
```php
// NOUVELLES FIXTURES √Ä CR√âER
CommandeFixtures::class
‚îú‚îÄ‚îÄ 10 commandes diff√©rents statuts
‚îú‚îÄ‚îÄ Liens vers devis existants
‚îú‚îÄ‚îÄ Dates coh√©rentes avec workflow
‚îî‚îÄ‚îÄ CommandeItems avec productions vari√©es

FactureFixtures::class
‚îú‚îÄ‚îÄ 15 factures (brouillon/envoy√©e/pay√©e)
‚îú‚îÄ‚îÄ Liens commandes ou cr√©ation directe
‚îú‚îÄ‚îÄ √âch√©ances vari√©es (courantes/d√©pass√©es)
‚îî‚îÄ‚îÄ FactureItems coh√©rents

AvoirFixtures::class  
‚îú‚îÄ‚îÄ 5 avoirs diff√©rents motifs
‚îú‚îÄ‚îÄ Statuts brouillon/valid√©/rembours√©
‚îú‚îÄ‚îÄ Liens vers factures existantes
‚îî‚îÄ‚îÄ Montants partiels et totaux

PaiementFixtures::class
‚îú‚îÄ‚îÄ Paiements factures (partiels/complets)
‚îú‚îÄ‚îÄ Remboursements avoirs  
‚îú‚îÄ‚îÄ Modes paiement vari√©s
‚îî‚îÄ‚îÄ Dates encaissement r√©alistes
```

### **7.2 Donn√©es de Configuration**
```php
// PARAM√àTRES SYST√àME √Ä AJOUTER
DELAIS_DEFAUT:
- delai_preparation: 3 jours
- delai_production: 7 jours  
- delai_expedition: 2 jours
- delai_paiement: 30 jours

MOTIFS_AVOIR:
- retour_marchandise: "Retour de marchandise"
- ristourne_commerciale: "Ristourne commerciale"
- erreur_facturation: "Erreur de facturation"  
- geste_commercial: "Geste commercial"
- annulation_partielle: "Annulation partielle"

MODES_PAIEMENT:
- cheque: "Ch√®que"
- virement: "Virement bancaire"
- carte_bancaire: "Carte bancaire"
- especes: "Esp√®ces"
- prelevement: "Pr√©l√®vement automatique"

SEUILS_VALIDATION:
- montant_avoir_validation: 500.00 (euros)
- delai_relance_facture: 30 (jours)
- delai_contentieux: 90 (jours)
```

---

## üöÄ 8. PLAN D'IMPL√âMENTATION

### **8.1 Phase 1 - Fondations (5 jours)**
```php
JOUR 1-2: ENTIT√âS ET MIGRATIONS
- Cr√©ation toutes les entit√©s avec annotations
- Relations et contraintes de base  
- Migrations avec contraintes
- Tests unitaires entit√©s

JOUR 3-4: SERVICES M√âTIER
- CommandeService avec conversions
- FactureService avec calculs
- AvoirService avec validations
- WorkflowService √©tendu

JOUR 5: FIXTURES ET DONN√âES
- Fixtures compl√®tes pour tests
- Configuration param√®tres syst√®me
- Donn√©es r√©f√©rentiels (motifs, modes)
- Validation coh√©rence donn√©es
```

### **8.2 Phase 2 - Interfaces (4 jours)**
```php
JOUR 6-7: CONTR√îLEURS ET FORMULAIRES  
- Contr√¥leurs CRUD complets
- Formulaires avec validation
- Actions sp√©cialis√©es (validation, envoi)
- Gestion erreurs et s√©curit√©

JOUR 8-9: TEMPLATES ET DESIGN
- Templates coh√©rents avec existant
- Composants r√©utilisables (statut, timeline)
- Responsive design mobile
- Tests navigation et UX
```

### **8.3 Phase 3 - Int√©gration (3 jours)**
```php
JOUR 10-11: WORKFLOW COMPLET
- Int√©gration Devis ‚Üí Commande
- Liaison Commande ‚Üí Facture  
- Cr√©ation Facture ‚Üí Avoir
- Tests bout-en-bout

JOUR 12: FINALISATION
- Dashboard √©tendu avec nouveaux widgets
- Exports PDF tous documents
- Emails notifications
- Tests de performance
- Documentation utilisateur
```

### **8.4 Phase 4 - Tests et D√©ploiement (2 jours)**
```php
JOUR 13: TESTS COMPLETS
- Tests automatis√©s complets
- Tests utilisateurs sur workflows
- Validation r√®gles m√©tier
- Corrections bugs identifi√©s

JOUR 14: MISE EN PRODUCTION
- Migration donn√©es production  
- Formation utilisateurs
- Surveillance post-d√©ploiement
- Ajustements configuration
```

---

## ‚úÖ 9. CRIT√àRES DE VALIDATION

### **9.1 Fonctionnels**
- ‚úÖ Workflow complet Devis ‚Üí Commande ‚Üí Facture ‚Üí Avoir op√©rationnel
- ‚úÖ Calculs automatiques corrects sur tous documents  
- ‚úÖ Validation des avoirs avec approbation manag√©riale
- ‚úÖ Suivi paiements et soldes en temps r√©el
- ‚úÖ G√©n√©ration PDF professionnels tous documents
- ‚úÖ Emails notifications automatiques  
- ‚úÖ Dashboard √©tendu avec KPI temps r√©el

### **9.2 Techniques**  
- ‚úÖ Performance < 1s sur toutes pages principales
- ‚úÖ S√©curit√© : contr√¥les droits et validations m√©tier
- ‚úÖ Tests automatis√©s > 80% couverture code
- ‚úÖ Base donn√©es optimis√©e avec index appropri√©s
- ‚úÖ Code maintenable avec documentation compl√®te
- ‚úÖ Compatibilit√© mobile responsive
- ‚úÖ Sauvegarde/restauration donn√©es valid√©e

### **9.3 M√©tier**
- ‚úÖ Respect r√®gles comptables fran√ßaises
- ‚úÖ Tra√ßabilit√© compl√®te des op√©rations  
- ‚úÖ Coh√©rence montants et statuts garantie
- ‚úÖ Gestion erreurs et cas exceptionnels
- ‚úÖ √âvolutivit√© pour modules futurs
- ‚úÖ Formation utilisateurs r√©alis√©e
- ‚úÖ Documentation administrative compl√®te

---

## üìû 10. SUPPORT ET MAINTENANCE

### **10.1 Documentation**
- **Manuel utilisateur** avec captures d'√©cran
- **Guide administrateur** param√©trage syst√®me  
- **Documentation technique** d√©veloppeurs
- **Proc√©dures de sauvegarde** et restauration

### **10.2 Formation**
- **Session formation** utilisateurs finaux (2h)
- **Formation administrateurs** syst√®me (1h)  
- **Support t√©l√©phonique** 3 mois post-d√©ploiement
- **Webinaires** nouvelles fonctionnalit√©s

### **10.3 √âvolutions Futures**
- **Module comptabilit√©** (√©critures automatiques)
- **Module stock** (gestion inventaires)  
- **API REST** (int√©grations externes)
- **Application mobile** commerciaux
- **BI/Reporting** avanc√© avec graphiques

---

**FIN DU DOCUMENT DE SP√âCIFICATIONS**

*Ce document constitue la base contractuelle pour le d√©veloppement du module Workflow Commercial Complet de TechnoProd. Toute modification doit faire l'objet d'un avenant valid√© par les parties.*

**Version :** 1.0  
**Date :** 22 Juillet 2025  
**Pages :** 23  
**Validation :** En attente retours client